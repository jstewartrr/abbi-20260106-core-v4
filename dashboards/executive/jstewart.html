<!DOCTYPE html>
<!-- ABBI Executive Dashboard v9.7.0-TRIAGE - Connected to triaged emails from Hive Mind -->
<!-- Force refresh: 2026-01-26T00:55:00Z -->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Executive Dashboard v9.5.0 | ABBI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%238b5cf6'/></svg>">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#0a0a0f;--bg2:#12121a;--card:#1a1a25;--border:#2a2a3a;--purple:#8b5cf6;--blue:#3b82f6;--green:#22c55e;--amber:#f59e0b;--red:#ef4444;--text:#f1f5f9;--text2:#94a3b8;--text3:#64748b}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:10px}
        a{color:var(--purple);text-decoration:none}
        a:hover{text-decoration:underline}
        
        /* Login */
        .login-overlay{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999}
        .login-box{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:40px;width:100%;max-width:400px;text-align:center}
        .login-logo{width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,var(--purple),var(--blue));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:24px;color:#fff;margin:0 auto 20px}
        .login-title{font-size:1.5rem;font-weight:700;margin-bottom:8px}
        .login-subtitle{color:var(--text2);margin-bottom:24px}
        .login-input{width:100%;padding:14px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:1rem;margin-bottom:16px}
        .login-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--purple),var(--blue));border:none;border-radius:10px;color:#fff;font-weight:600;cursor:pointer}
        .login-error{color:var(--red);margin-top:12px;display:none}
        
        /* Nav */
        .nav{position:fixed;top:0;left:0;right:0;height:60px;background:rgba(18,18,26,.95);border-bottom:1px solid var(--border);display:none;align-items:center;padding:0 20px;z-index:1000}
        .nav-brand{display:flex;align-items:center;gap:10px}
        .nav-logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--purple),var(--blue));display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:16px}
        .nav-title{font-weight:700;background:linear-gradient(90deg,var(--purple),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-size:16px}
        .nav-links{display:flex;gap:4px;flex:1;margin-left:32px}
        .nav-link{padding:8px 14px;border-radius:8px;color:var(--text2);text-decoration:none;font-size:16px}
        .nav-link.active{background:var(--purple);color:#fff}
        .nav-right{display:flex;align-items:center;gap:12px}
        .nav-status{display:flex;align-items:center;gap:6px;padding:6px 12px;border-radius:20px;background:rgba(34,197,94,.1);color:var(--green)}
        .status-dot{width:8px;height:8px;border-radius:50%;background:var(--green)}
        .nav-logout{background:0;border:1px solid var(--border);border-radius:6px;padding:6px 12px;color:var(--text2);cursor:pointer}
        .nav-refresh-btn{background:linear-gradient(135deg,var(--purple),var(--blue));border:none;border-radius:6px;padding:6px 12px;color:#fff;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:.75rem;transition:all .2s}
        .nav-refresh-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(139,92,246,.3)}
        .nav-refresh-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
        .nav-refresh-btn .spinner{animation:spin 1s linear infinite;display:inline-block}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* Main */
        .main{display:none;padding:70px 20px 20px;max-width:1800px;margin:0 auto;overflow-x:auto}
        
        /* Three Column Layout with Collapsible Panes */
        .dashboard-container{display:grid;grid-template-columns:260px 1fr 280px;gap:10px;margin-bottom:20px;transition:grid-template-columns .3s ease;align-items:start}
        .dashboard-container.left-collapsed{grid-template-columns:48px 1fr 280px}
        .dashboard-container.right-collapsed{grid-template-columns:260px 1fr 48px}
        .dashboard-container.both-collapsed{grid-template-columns:48px 1fr 48px}
        @media(max-width:1600px){.dashboard-container{grid-template-columns:240px 1fr 260px} .left-pane{max-width:240px} .right-pane{max-width:260px}}
        @media(max-width:1400px){.dashboard-container{grid-template-columns:220px 1fr 240px} .left-pane{max-width:220px} .right-pane{max-width:240px}}
        @media(max-width:1200px){.dashboard-container{grid-template-columns:200px 1fr 220px;gap:12px} .left-pane{max-width:200px} .right-pane{max-width:220px}}

        .left-pane,.right-pane{display:flex;flex-direction:column;gap:4px;position:relative;transition:all .3s ease;overflow:hidden;min-width:0}
        .left-pane{max-width:260px}
        .right-pane{max-width:280px}
        .left-pane.collapsed,.right-pane.collapsed{width:48px;min-width:48px;max-width:48px}
        .left-pane.collapsed .metric-card,.right-pane.collapsed .section-card{display:none}

        /* Collapse Toggle Buttons - positioned in center pane */
        .collapse-toggle{position:absolute;width:32px;height:32px;border-radius:8px;background:var(--bg2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;transition:all .2s;opacity:0;top:50%;transform:translateY(-50%)}
        .collapse-toggle:hover{background:var(--purple);border-color:var(--purple);color:#fff;opacity:1}
        .collapse-toggle-left{left:-16px}
        .collapse-toggle-right{right:-16px}
        .central-view{position:relative}

        /* Hover zones for dividers - invisible areas that trigger button visibility */
        .divider-hover-zone{position:absolute;top:0;bottom:0;width:60px;z-index:9}
        .divider-hover-zone-left{left:-30px;cursor:ew-resize}
        .divider-hover-zone-right{right:-30px;cursor:ew-resize}
        .divider-hover-zone-left:hover + .divider-hover-zone-right + .collapse-toggle-left,
        .central-view:has(.divider-hover-zone-left:hover) .collapse-toggle-left{opacity:1}
        .central-view:has(.divider-hover-zone-right:hover) .collapse-toggle-right{opacity:1}

        /* Metric Cards */
        .metric-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:5px;transition:all .2s;width:100%;max-width:100%;box-sizing:border-box}
        .metric-card-title{font-size:.9rem;font-weight:700;text-transform:uppercase;color:var(--text);margin-bottom:6px;letter-spacing:.5px;cursor:pointer;user-select:none;display:flex;justify-content:space-between;align-items:center}
        .metric-card-title:hover{color:var(--purple)}
        .metric-card-title .collapse-icon{font-size:.7rem;transition:transform .2s;opacity:.6}
        .metric-card-title .collapse-icon.collapsed{transform:rotate(-90deg)}
        .metric-card-content{max-height:2000px;overflow:hidden;transition:max-height .3s ease}
        .metric-card-content.collapsed{max-height:0}
        .section-content-wrapper{max-height:2000px;overflow:hidden;transition:max-height .3s ease}
        .section-content-wrapper.collapsed{max-height:0}
        .section-header .collapse-icon.collapsed{transform:rotate(-90deg)}
        .metric-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);cursor:pointer;transition:all .2s}
        .metric-row:last-child{border-bottom:0}
        .metric-row:hover{background:var(--bg2);margin:0 -8px;padding:6px 8px}
        .metric-row.active{background:rgba(139,92,246,.1);margin:0 -8px;padding:6px 8px;border-left:3px solid var(--purple)}
        .metric-label{font-size:.7rem;color:var(--text2)}
        .metric-value{font-size:.8rem;font-weight:700;color:var(--text)}
        .metric-value.high{color:var(--red)}
        .metric-value.amber{color:var(--amber)}
        .metric-value.green{color:var(--green)}
        .metric-value.purple{color:var(--purple)}
        
        /* Asana Projects */
        .asana-projects{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap}
        .asana-link{display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--card);border:1px solid var(--border);border-radius:10px;color:var(--text);text-decoration:none;font-size:.7rem;font-weight:500;transition:all .2s}
        .asana-link:hover{border-color:var(--purple);text-decoration:none;transform:translateY(-1px)}
        .asana-link-icon{font-size:1rem}
        
        /* Central Viewing Area */
        .central-view{margin-bottom:16px;min-width:0;display:flex;flex-direction:column;height:calc(100vh - 140px)}
        .view-header{margin-bottom:4px;flex-shrink:0}
        .view-header h2{margin:0;font-size:.9rem;color:var(--text)}

        /* Content List */
        .content-list{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow-y:auto;flex:1;min-height:200px}

        /* Email List - Collapsed State */
        .email-item{display:flex;flex-direction:column;border-bottom:1px solid var(--border);transition:all .2s;cursor:pointer}
        .email-item:hover{background:var(--bg2)}
        .email-item:last-child{border-bottom:0}

        /* Email List Header (collapsed view) */
        .email-header{display:flex;align-items:flex-start;gap:12px;padding:10px 12px}
        .email-priority{width:4px;min-height:50px;border-radius:2px;flex-shrink:0}
        .email-priority.high{background:var(--red)}
        .email-priority.medium{background:var(--amber)}
        .email-priority.low{background:var(--green)}
        .email-content{flex:1;min-width:0}
        .email-from{font-weight:600;font-size:.75rem;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .email-subject{font-size:.7rem;color:var(--text2);margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .email-preview{font-size:.65rem;color:var(--text3);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
        .email-meta{display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0}
        .email-time{font-size:.65rem;color:var(--text3)}

        /* Email Expanded View - Stacked Cards */
        .email-expanded-view{display:flex;flex-direction:column;gap:6px;padding:10px}

        /* Email Card - Content */
        .email-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
        .email-card-title{font-size:.6rem;text-transform:uppercase;color:var(--purple);font-weight:700;margin-bottom:6px;letter-spacing:.5px}
        .email-detail-header{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:6px;margin-bottom:6px}
        .email-detail-from{font-weight:600;font-size:.75rem;color:var(--text);margin-bottom:2px}
        .email-detail-subject{font-size:.7rem;color:var(--text2);margin-bottom:4px}
        .email-detail-date{font-size:.55rem;color:var(--text3)}
        .email-body-content{font-size:.65rem;color:var(--text2);line-height:1.5;max-height:400px;overflow-y:auto;padding:6px;background:var(--bg);border-radius:6px}

        /* AI Analysis Card */
        .ai-analysis-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px}
        .ai-section{background:var(--bg);padding:6px;border-radius:6px;margin-bottom:5px;border-left:3px solid var(--purple)}
        .ai-section:last-child{margin-bottom:0}
        .ai-section-label{font-weight:700;font-size:.6rem;color:var(--text);margin-bottom:4px}
        .ai-section-content{font-size:.65rem;color:var(--text2);line-height:1.4}

        /* Response Card */
        .response-card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px}
        .response-editor{background:var(--bg);border:1px solid var(--border);border-radius:6px;padding:10px;font-size:.65rem;color:var(--text);line-height:1.5;min-height:180px;resize:vertical;font-family:'DM Sans',sans-serif;width:100%;margin-bottom:10px}
        .response-actions{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px}
        .response-btn{padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:var(--bg2);color:var(--text);font-size:.8rem;font-weight:500;cursor:pointer;transition:all .2s;text-align:center;display:flex;align-items:center;justify-content:center;gap:6px}
        .response-btn:hover{background:var(--purple);border-color:var(--purple);color:#fff}
        .response-btn.primary{background:var(--purple);border-color:var(--purple);color:#fff}
        .response-btn.primary:hover{opacity:.9}
        .response-btn svg{width:14px;height:14px;flex-shrink:0}
        .attach-input{display:none}
        .forward-section{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:12px}
        .forward-section-title{font-weight:600;color:var(--text);margin-bottom:12px;font-size:.85rem}
        .forward-input{width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.85rem;margin-bottom:12px;font-family:'DM Sans',sans-serif}
        .forward-textarea{width:100%;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.85rem;min-height:80px;resize:vertical;font-family:'DM Sans',sans-serif;margin-bottom:12px}

        .no-selection{text-align:center;color:var(--text3);padding:40px 20px}
        
        /* Section Grid */
        .section-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:10px}
        .section-card{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden;width:100%;max-width:100%;box-sizing:border-box}
        .section-header{padding:8px 10px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .section-title{font-weight:600;font-size:1rem}
        .section-badge{background:var(--purple);color:#fff;padding:3px 10px;border-radius:10px;font-size:.6rem}
        .availability-indicator{width:12px;height:12px;border-radius:50%;background:var(--green);flex-shrink:0;border:3px solid var(--border);box-shadow:0 0 0 1px var(--text3);cursor:help}
        .availability-indicator.meeting-soon{background:var(--amber)}
        .availability-indicator.meeting-very-soon{background:#fb923c}
        .availability-indicator.in-meeting{background:var(--blue)}
        .section-content{padding:4px 5px;max-height:350px;overflow-y:auto}
        
        /* Items */
        .item{display:flex;align-items:center;gap:1px;padding:4px 0;border-bottom:1px solid var(--border)}
        .item:last-child{border-bottom:0}
        .item-priority{width:4px;height:36px;border-radius:2px}
        .item-priority.high{background:var(--red)}
        .item-priority.medium{background:var(--amber)}
        .item-priority.low{background:var(--green)}
        .item-content{flex:1}
        .item-title{font-weight:500;font-size:.7rem;margin-bottom:2px}
        .item-title a{color:var(--text);text-decoration:none}
        .item-title a:hover{color:var(--purple)}
        .item-meta{font-size:.6rem;color:var(--text3)}
        .item-badge{font-size:.6rem;padding:4px 8px;border-radius:4px;background:var(--bg2)}
        .item-badge.overdue{background:rgba(239,68,68,.15);color:var(--red)}
        .item-time{font-weight:600;color:var(--purple);min-width:45px;font-size:.7rem}
        
        /* Portfolio */
        .portfolio-status{font-size:.6rem;padding:4px 10px;border-radius:10px}
        .portfolio-status.good{background:rgba(34,197,94,.15);color:var(--green)}
        .portfolio-status.watch{background:rgba(245,158,11,.15);color:var(--amber)}
        .portfolio-status.critical{background:rgba(239,68,68,.15);color:var(--red)}
        
        /* Hive */
        .hive-cat{font-size:.65rem;padding:3px 8px;border-radius:4px;font-weight:600;text-transform:uppercase}
        .hive-cat.action{background:rgba(245,158,11,.15);color:var(--amber)}
        .hive-cat.context{background:rgba(139,92,246,.15);color:var(--purple)}
        .hive-src{font-size:.7rem;color:var(--text3)}
        .hive-sum{font-size:.8rem;color:var(--text2);margin-top:4px}
        .hive-time{font-size:.65rem;color:var(--text3);margin-top:4px}
        
        @media(max-width:768px){
            .section-grid{grid-template-columns:1fr}
            .stats-grid{grid-template-columns:repeat(2,1fr)}
            .email-tabs{flex-direction:column}
        }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-box">
            <div class="login-logo">AI</div>
            <div class="login-title">Executive Dashboard</div>
            <div class="login-subtitle">Enter your Sovereign Mind access token</div>
            <input type="password" class="login-input" id="tokenInput" placeholder="SM-xxxxxxxxxxxx" onkeypress="if(event.key==='Enter')attemptLogin()">
            <button class="login-btn" onclick="attemptLogin()">Access Dashboard</button>
            <div class="login-error" id="loginError">Invalid token</div>
        </div>
    </div>
    
    <!-- Nav -->
    <nav class="nav">
        <div class="nav-brand">
            <div class="nav-logo">AI</div>
            <span class="nav-title">ABBI Executive</span>
        </div>
        <div class="nav-links">
            <a href="https://abbi-ai.com" class="nav-link">‚Üê Main</a>
            <span class="nav-link active">Executive</span>
        </div>
        <div class="nav-right">
            <div class="nav-status"><span class="status-dot"></span>Live</div>
            <span style="font-size:.85rem;color:var(--purple);margin-left:12px;font-weight:600;padding:4px 10px;background:rgba(139,92,246,.1);border-radius:6px">v9.7.0-TRIAGE</span>
            <span id="contact-sync-time" style="font-size:.75rem;color:var(--text3);margin-left:12px;padding:4px 8px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;display:none" title="Last contact database sync">üìá Synced: <span id="contact-sync-timestamp">--</span></span>
            <span id="weather-display" style="display:flex;align-items:center;gap:8px"></span>
            <span id="header-time-display" style="font-size:.85rem;font-weight:500;color:var(--text)"></span>
            <button id="refresh-emails-btn" class="nav-refresh-btn" onclick="manualRefreshEmails()" title="Manually trigger email triage and refresh cache">
                <span id="refresh-icon">üîÑ</span>
                <span id="refresh-text">Refresh Emails</span>
            </button>
            <button class="nav-logout" onclick="logout()">Logout</button>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="main">
        <!-- Three Column Dashboard -->
        <div class="dashboard-container" id="dashboardContainer">
            <!-- Left Pane -->
            <div class="left-pane" id="leftPane">
                <!-- EMAIL Card -->
                <div class="metric-card" id="email-card">
                    <div class="metric-card-title" onclick="toggleMetricCard('email-card')">
                        <span style="display:flex;align-items:center;gap:8px"><span class="collapse-icon">‚ñº</span> EMAIL</span>
                    </div>
                    <div class="metric-card-content">
                    <div class="metric-row" data-view="email-unprocessed" onclick="switchMetricView('email-unprocessed')">
                        <span class="metric-label">UNPROCESSED</span>
                        <span class="metric-value high" id="email-unprocessed">0</span>
                    </div>
                    <div style="border-top:1px solid var(--border);margin:8px 0;opacity:0.3"></div>
                    <div class="metric-row" data-view="email-urgent-priority" onclick="switchMetricView('email-urgent-priority')">
                        <span class="metric-label">Urgent/Priority</span>
                        <span class="metric-value high" id="email-urgent-priority">0</span>
                    </div>
                    <div class="metric-row" data-view="email-to-need-response" onclick="switchMetricView('email-to-need-response')">
                        <span class="metric-label">To: Need Response/Action</span>
                        <span class="metric-value amber" id="email-to-need-response">0</span>
                    </div>
                    <div class="metric-row" data-view="email-to-fyi" onclick="switchMetricView('email-to-fyi')">
                        <span class="metric-label">To: FYI</span>
                        <span class="metric-value" id="email-to-fyi">0</span>
                    </div>
                    <div class="metric-row" data-view="email-cc-need-response" onclick="switchMetricView('email-cc-need-response')">
                        <span class="metric-label">CC: Need Response/Action</span>
                        <span class="metric-value" id="email-cc-need-response">0</span>
                    </div>
                    <div class="metric-row" data-view="email-cc-fyi" onclick="switchMetricView('email-cc-fyi')">
                        <span class="metric-label">CC: FYI</span>
                        <span class="metric-value" id="email-cc-fyi">0</span>
                    </div>
                    </div>
                </div>

                <!-- RECEIVED TASKS Card -->
                <div class="metric-card" id="tasks-card">
                    <div class="metric-card-title" onclick="toggleMetricCard('tasks-card')">
                        <span style="display:flex;align-items:center;gap:8px"><span class="collapse-icon">‚ñº</span> RECEIVED TASKS</span>
                    </div>
                    <div class="metric-card-content">
                    <div class="metric-row" data-view="tasks-received" onclick="switchMetricView('tasks-received')">
                        <span class="metric-label">Received Today</span>
                        <span class="metric-value" id="tasks-received-today">0</span>
                    </div>
                    <div class="metric-row" data-view="tasks-due" onclick="switchMetricView('tasks-due')">
                        <span class="metric-label">Due Today</span>
                        <span class="metric-value amber" id="tasks-due-today">0</span>
                    </div>
                    <div class="metric-row" data-view="tasks-overdue" onclick="switchMetricView('tasks-overdue')">
                        <span class="metric-label">Past Due</span>
                        <span class="metric-value high" id="tasks-past-due">0</span>
                    </div>
                    </div>
                </div>

                <!-- Asana Project Links -->
                <div class="metric-card" id="asana-card">
                    <div class="metric-card-title" onclick="toggleMetricCard('asana-card')">
                        <span style="display:flex;align-items:center;gap:8px"><span class="collapse-icon">‚ñº</span> ASANA PROJECTS</span>
                    </div>
                    <div class="metric-card-content">
                    <a href="https://app.asana.com/0/1204554210439476/list" target="_blank" class="asana-link" style="margin-bottom:8px">
                        MP Project Dashboard
                    </a>
                    <a href="https://app.asana.com/0/1212197943409021/list" target="_blank" class="asana-link" style="margin-bottom:8px">
                        John's Weekly Items
                    </a>
                    <a href="https://app.asana.com/0/1209783905568586/list" target="_blank" class="asana-link" style="margin-bottom:8px">
                        MP Daily Briefing
                    </a>
                    <a href="https://app.asana.com/0/portfolio/1208927693498631" target="_blank" class="asana-link">
                        Sovereign Mind Portfolio
                    </a>
                    </div>
                </div>
            </div>

            <!-- Main Viewing Area (Center) -->
            <div class="central-view">
                <!-- Hover zones for dividers -->
                <div class="divider-hover-zone divider-hover-zone-left"></div>
                <div class="divider-hover-zone divider-hover-zone-right"></div>

                <!-- Collapse buttons in center pane -->
                <div class="collapse-toggle collapse-toggle-left" onclick="toggleLeftPane()" title="Toggle left panel">
                    <span id="leftToggleIcon">‚óÄ</span>
                </div>
                <div class="collapse-toggle collapse-toggle-right" onclick="toggleRightPane()" title="Toggle right panel">
                    <span id="rightToggleIcon">‚ñ∂</span>
                </div>

                <div class="view-header">
                    <h2 id="view-title">URGENT Emails</h2>
                </div>

                <!-- Split Content Area -->
                <div style="display:flex;flex-direction:column;gap:0;flex:1;min-height:0">
                    <!-- Top: Content List -->
                    <div class="content-list" id="contentList" style="flex:1;min-height:200px;border-radius:12px 12px 0 0">
                        <div class="no-selection"><p>Loading...</p></div>
                    </div>

                    <!-- Resizable Divider -->
                    <div id="splitDivider" style="height:4px;flex-shrink:0;background:var(--border);cursor:ns-resize;position:relative">
                        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:40px;height:3px;background:var(--text3);border-radius:2px"></div>
                    </div>

                    <!-- Bottom: ABBI Chat -->
                    <div id="abbiChatPanel" style="height:300px;min-height:150px;max-height:600px;flex-shrink:0;background:var(--card);border:1px solid var(--border);border-radius:0 0 12px 12px;display:flex;flex-direction:column;overflow:hidden">
                        <!-- Chat Header -->
                        <div style="padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;background:var(--bg)">
                            <div style="display:flex;align-items:center;gap:8px">
                                <span style="font-size:1.1rem">üí¨</span>
                                <span style="font-weight:600;color:var(--purple)">ABBI</span>
                                <span style="font-size:.75rem;color:var(--text3)">Chat with context from above</span>
                            </div>
                            <button onclick="toggleAbbiChat()" style="padding:4px 8px;background:transparent;border:1px solid var(--border);border-radius:4px;cursor:pointer;color:var(--text3);font-size:.85rem">‚ñº Hide</button>
                        </div>

                        <!-- Chat Messages -->
                        <div id="abbiChatMessages" style="flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px">
                            <div style="padding:20px;text-align:center;color:var(--text3);font-size:.85rem">
                                Ask me anything about the content above, or give me instructions to process emails, update calendar, etc.
                            </div>
                        </div>

                        <!-- Chat Input -->
                        <div style="padding:12px 16px;border-top:1px solid var(--border);background:var(--bg);display:flex;gap:10px;align-items:flex-end">
                            <textarea id="abbiChatInput" placeholder="Ask ABBI anything about the content above..." style="flex:1;padding:10px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:.9rem;resize:vertical;min-height:44px;max-height:200px;white-space:pre-wrap;word-wrap:break-word;overflow-wrap:break-word;line-height:1.4" onkeypress="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); sendAbbiMessage(); }" rows="1"></textarea>
                            <button onclick="sendAbbiMessage()" style="padding:10px 20px;background:var(--purple);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:500;font-size:.9rem;flex-shrink:0">Send</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Pane -->
            <div class="right-pane" id="rightPane">
                <!-- Calendar Card -->
                <div class="section-card" id="calendar-card">
                    <div class="section-header" onclick="toggleSectionCard('calendar-card')" style="cursor:pointer;user-select:none">
                        <span style="display:flex;align-items:center;gap:8px">
                            <span class="collapse-icon" style="font-size:.7rem;transition:transform .2s;opacity:.6">‚ñº</span>
                            <span class="section-title">Calendar</span>
                        </span>
                        <span class="availability-indicator" id="availability-indicator" onclick="event.stopPropagation()"></span>
                    </div>
                    <div class="section-content-wrapper">
                    <div class="section-content" id="schedule-container">
                        <div style="padding:1rem;color:var(--text3);text-align:center">No meetings today</div>
                    </div>
                    </div>
                </div>

                <!-- Portfolio Card (Future Use) -->
                <div class="section-card" id="portfolio-card">
                    <div class="section-header" onclick="toggleSectionCard('portfolio-card')" style="cursor:pointer;user-select:none">
                        <span style="display:flex;align-items:center;gap:8px">
                            <span class="collapse-icon" style="font-size:.7rem;transition:transform .2s;opacity:.6">‚ñº</span>
                            <span class="section-title">Portfolio</span>
                        </span>
                        <span style="font-size:.85rem;color:var(--text3)" onclick="event.stopPropagation()">Future use</span>
                    </div>
                    <div class="section-content-wrapper">
                    <div class="section-content" id="portfolio-container">
                        <div class="item">
                            <div class="item-content">
                                <div class="item-title"><a href="https://app.asana.com" target="_blank">Shiloh Industries</a></div>
                            </div>
                            <span class="portfolio-status watch">Watch</span>
                        </div>
                        <div class="item">
                            <div class="item-content">
                                <div class="item-title"><a href="https://app.asana.com" target="_blank">PACE Industries</a></div>
                            </div>
                            <span class="portfolio-status critical">Restructuring</span>
                        </div>
                        <div class="item">
                            <div class="item-content">
                                <div class="item-title"><a href="https://app.asana.com" target="_blank">IT8</a></div>
                            </div>
                            <span class="portfolio-status good">On Track</span>
                        </div>
                        <div class="item">
                            <div class="item-content">
                                <div class="item-title"><a href="https://app.asana.com" target="_blank">Xtrac</a></div>
                            </div>
                            <span class="portfolio-status good">On Track</span>
                        </div>
                        <div class="item">
                            <div class="item-content">
                                <div class="item-title"><a href="https://app.asana.com" target="_blank">Fund III</a></div>
                            </div>
                            <span class="portfolio-status watch">Active</span>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- ABBI Card (Future Use) -->
                <div class="section-card" id="abbi-card">
                    <div class="section-header" onclick="toggleSectionCard('abbi-card')" style="cursor:pointer;user-select:none">
                        <span style="display:flex;align-items:center;gap:8px">
                            <span class="collapse-icon" style="font-size:.7rem;transition:transform .2s;opacity:.6">‚ñº</span>
                            <span class="section-title">ABBI</span>
                        </span>
                        <span style="font-size:.85rem;color:var(--text3)" onclick="event.stopPropagation()">Future use</span>
                    </div>
                    <div class="section-content-wrapper">
                    <div class="section-content">
                        <div style="padding:20px 0;text-align:center;color:var(--text3);font-size:.85rem">
                            Coming soon
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script>
        const CONFIG = {
            VALID_TOKEN_HASH: '9b74f3a0e5c72a838737cd59fd71a2e62324b4860c236da7b801f980c65f58f0',
            API_BASE: '/api/email/triaged-emails',
            DEBUG: true  // Enable debug mode
        };

        // Live data storage
        let liveData = {
            calendar: [],
            emails: [],
            tasks: [],
            activity: []
        };

        // Sample email data (fallback)
        const emailData = {
            to: [
                { id: 1, from: 'Michael Chen', subject: 'Fund III LP Commitment Update', preview: 'Hi John, I wanted to follow up on the LP commitment discussion from yesterday...', time: '10:32 AM', priority: 'high', link: 'https://outlook.office.com/mail/inbox/id/AAMkAGE', summary: 'Michael is following up on the Fund III LP commitment discussion. He mentions that the sovereign wealth fund has indicated interest in a $50M commitment pending final IC approval. He requests a call this week to finalize terms.' },
                { id: 2, from: 'Sarah Williams', subject: 'PACE Industries - Q4 Review Materials', preview: 'Please find attached the Q4 review materials for the upcoming board meeting...', time: '9:15 AM', priority: 'medium', link: 'https://outlook.office.com/mail/inbox/id/AAMkAGF', summary: 'Sarah has sent Q4 review materials for PACE Industries board meeting. Key highlights include revenue miss of 8% vs plan, but EBITDA margins improved. She recommends reviewing slides 12-18 before the call.' },
                { id: 3, from: 'David Park', subject: 'Shiloh Site Visit Confirmation', preview: 'Confirming our site visit to Shiloh manufacturing facility on the 15th...', time: '8:45 AM', priority: 'low', link: 'https://outlook.office.com/mail/inbox/id/AAMkAGG', summary: 'Site visit to Shiloh manufacturing facility confirmed for January 15th at 10 AM. David will arrange transportation from the hotel. Suggests wearing safety boots for plant floor tour.' },
            ],
            cc: [
                { id: 4, from: 'Investment Committee', subject: 'RE: IC Meeting Minutes - Jan 6', preview: 'Minutes from yesterday IC meeting attached for review...', time: '11:00 AM', priority: 'low', link: 'https://outlook.office.com/mail/inbox/id/AAMkAGH', summary: 'IC meeting minutes from January 6th. Key decisions: Approved $25M follow-on for IT8, deferred Xtrac distribution decision to Q2, discussed Fund III LP pipeline progress.' },
                { id: 5, from: 'Legal Team', subject: 'Fund III Documentation Updates', preview: 'Updated LPA drafts reflecting the latest negotiations...', time: '10:00 AM', priority: 'medium', link: 'https://outlook.office.com/mail/inbox/id/AAMkAGI', summary: 'Legal has updated LPA drafts with negotiated changes from anchor LP. Main changes: management fee step-down after Year 5, GP commitment increased to 3%, co-invest rights clarified.' },
                { id: 6, from: 'Finance', subject: 'Weekly Portfolio Cash Flow Report', preview: 'Attached is the weekly cash flow summary for all portfolio companies...', time: '7:30 AM', priority: 'low', link: 'https://outlook.office.com/mail/inbox/id/AAMkAGJ', summary: 'Weekly cash flow report shows portfolio aggregate cash position of $142M. PACE drew $5M on revolver, Shiloh returned $2M. No liquidity concerns flagged.' },
            ],
            meeting: [
                { id: 7, from: 'James Thompson', subject: 'Meeting Request: Fund III Strategy Review', preview: 'Would like to schedule 30 minutes to discuss Fund III deployment strategy...', time: 'Yesterday', priority: 'high', link: 'https://outlook.office.com/mail/inbox/id/AAMkAGK', summary: 'James Thompson (MD) requesting 30-minute meeting to discuss Fund III deployment strategy. Suggests Wednesday or Thursday afternoon. Wants to review sector allocation and pipeline prioritization.' },
                { id: 8, from: 'External: Goldman Sachs', subject: 'LP Introduction - Sovereign Wealth Fund', preview: 'Happy to facilitate an introduction to our contacts at...', time: 'Yesterday', priority: 'medium', link: 'https://outlook.office.com/mail/inbox/id/AAMkAGL', summary: 'Goldman offering to introduce Middle Eastern sovereign wealth fund interested in PE allocations. Fund size $50B+, targeting $100-200M commitments. Suggests initial call next week.' },
            ],
            overdue: [
                { id: 9, from: 'Asana', subject: 'Overdue: Review Fund III LP commitments', preview: 'This task was due on January 5, 2026...', time: '2 days ago', priority: 'high', link: 'https://app.asana.com/0/1209103059237595/1209103059237596', summary: 'Task overdue by 2 days. Original due date January 5th. Task involves reviewing and confirming LP commitment schedule for Fund III first close. Blocking IC approval.' },
                { id: 10, from: 'Asana', subject: 'Overdue: Submit board materials', preview: 'This task was due on January 6, 2026...', time: '1 day ago', priority: 'high', link: 'https://app.asana.com/0/1209103059237595/1209103059237599', summary: 'Task overdue by 1 day. Board materials for PACE Industries needed for January 10th meeting. Finance team awaiting your commentary on section 3.' },
            ],
            responded: [
                { id: 11, from: 'Michael Chen', subject: 'RE: Q1 Planning Session', preview: 'Thanks for confirming the dates. I will send calendar invites...', time: 'Yesterday', priority: 'low', link: 'https://outlook.office.com/mail/sentitems/id/AAMkAGM', summary: 'You confirmed Q1 planning session dates (Jan 20-21). Michael will send calendar invites and book conference room. Catering preferences requested.' },
                { id: 12, from: 'Sarah Williams', subject: 'RE: IT8 Distribution Analysis', preview: 'Great insights. I have incorporated your feedback into the model...', time: 'Yesterday', priority: 'low', link: 'https://outlook.office.com/mail/sentitems/id/AAMkAGN', summary: 'You provided feedback on IT8 distribution model. Sarah incorporated changes and will present updated analysis at IC meeting. Estimated distribution of $15M approved.' },
            ]
        };
        
        let currentView = 'email-unprocessed'; // Show unprocessed emails by default
        let expandedEmailId = null;
        let expandedMeetingId = null;
        let leftPaneCollapsed = false;
        let rightPaneCollapsed = false;
        
        // Auth functions
        async function hashToken(t) {
            const e = new TextEncoder().encode(t);
            const h = await crypto.subtle.digest('SHA-256', e);
            return Array.from(new Uint8Array(h)).map(b => b.toString(16).padStart(2, '0')).join('');
        }
        
        async function attemptLogin() {
            const t = document.getElementById('tokenInput').value.trim();
            const h = await hashToken(t);
            if (t === 'SM-c22da6c5433fc0c4a1a11e5d8b6e1082' || h === CONFIG.VALID_TOKEN_HASH) {
                localStorage.setItem('abbi_auth', CONFIG.VALID_TOKEN_HASH);
                showApp();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }
        
        function checkAuth() {
            if (localStorage.getItem('abbi_auth') === CONFIG.VALID_TOKEN_HASH) showApp();
        }
        
        async function showApp() {
            document.getElementById('loginOverlay').style.display = 'none';
            document.querySelector('.nav').style.display = 'flex';
            document.querySelector('.main').style.display = 'block';

            await fetchLiveData();
            renderContent(); // v8.88: Will auto-trigger Daily Briefing
            updateWeather();
            updateHeaderTime();
        }


        // Fetch live data from API
        async function fetchLiveData(filter = null) {
            try {
                console.log('=== FETCHING LIVE DATA ===');
                let url = CONFIG.API_BASE;
                if (filter) url += `?filter=${filter}`;
                console.log('API URL:', url);

                const response = await fetch(url);
                console.log('API response status:', response.status);
                console.log('API response ok:', response.ok);
                console.log('API response headers:', [...response.headers.entries()]);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API error response:', errorText);
                    throw new Error(`API returned ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('API response data:', data);

                if (data.success) {
                    // Map triaged emails to expected format
                    const emails = (data.emails || []).map(email => ({
                        ...email,
                        categories: ['Processed', email.category] // Add Processed tag and category
                    }));

                    liveData = {
                        emails: emails,
                        calendar: [],
                        tasks: [],
                        activity: []
                    };
                    console.log('‚úÖ Data loaded successfully:');
                    console.log('  - Emails:', liveData.emails?.length || 0);
                    console.log('  - Calendar:', liveData.calendar?.length || 0);
                    console.log('  - Tasks:', liveData.tasks?.length || 0);
                    console.log('  - Activity:', liveData.activity?.length || 0);

                    console.log('Calling updateDashboard()...');
                    updateDashboard();
                    console.log('‚úÖ updateDashboard() completed');
                } else {
                    console.error('API returned success=false:', data);
                    alert('API returned success=false');
                }
            } catch (error) {
                console.error('Error fetching live data:', error);

                // Show error on page for iPad users
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'position:fixed;top:70px;left:50%;transform:translateX(-50%);background:var(--red);color:#fff;padding:15px 25px;border-radius:8px;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.5);max-width:600px;text-align:center';
                errorDiv.innerHTML = `<strong>API Error</strong><br><span style="font-size:0.9rem">${error.message}</span>`;
                document.body.appendChild(errorDiv);

                // Auto-remove after 10 seconds
                setTimeout(() => errorDiv.remove(), 10000);
            }
        }

        // Switch view based on metric row clicked
        async function switchMetricView(view) {
            currentView = view;

            // Update active state on metric rows
            document.querySelectorAll('.metric-row').forEach(row => {
                row.classList.remove('active');
            });
            const activeRow = document.querySelector(`.metric-row[data-view="${view}"]`);
            if (activeRow) activeRow.classList.add('active');

            // Check if this is a Daily Briefing category click
            const briefingCategoryMap = {
                'email-urgent-priority': 'Urgent/Priority',
                'email-to-need-response': 'To: Need Response/Action',
                'email-to-fyi': 'To: FYI',
                'email-cc-need-response': 'CC: Need Response/Action',
                'email-cc-fyi': 'CC: FYI'
            };

            // If Daily Briefing emails are loaded and this is a briefing category, filter them
            if (window.allBriefingEmails && briefingCategoryMap[view]) {
                console.log('üìß Switching to Daily Briefing category:', briefingCategoryMap[view]);
                filterBriefingByCategory(briefingCategoryMap[view]);
                return; // Don't call renderContent()
            }

            // Set view title
            const titles = {
                'tasks-received': 'Tasks Received Today',
                'tasks-due': 'Tasks Due Today',
                'tasks-overdue': 'Past Due Tasks',
                'email-unprocessed': 'UNPROCESSED Emails',
                'email-urgent-priority': 'Urgent/Priority',
                'email-to-need-response': 'To: Need Response/Action',
                'email-to-fyi': 'To: FYI',
                'email-cc-need-response': 'CC: Need Response/Action',
                'email-cc-fyi': 'CC: FYI',
                'email-priority': 'PRIORITY Emails (Needs Your Attention)',
                'email-urgent': 'URGENT Emails',
                'email-investor': 'Investor Emails',
                'email-portfolio-ceo-cfo': 'Portfolio CEO_CFO Emails',
                'email-needs-reply': 'Emails Needing Reply',
                'email-to-external': 'To: External',
                'email-to-internal': 'To: Internal',
                'email-cc-external': 'CC: External',
                'email-cc-internal': 'CC: Internal',
                'email-meeting-internal': 'Meeting Request: Internal',
                'email-meeting-external': 'Meeting Request: External',
                'email-fyi': 'FYI'
            };
            document.getElementById('view-title').textContent = titles[view] || 'Dashboard';

            // Fetch data if needed
            await fetchLiveData();
            renderContent();
        }

        // Update dashboard with live data

        function updateDashboard() {
            const now = new Date();
            const todayEST = now.toLocaleDateString('en-US', { timeZone: 'America/New_York' });

            // Filter tasks by due date
            const tasksToday = liveData.tasks.filter(t => {
                if (!t.due_on && !t.due_date) return false;
                const dueDate = new Date(t.due_on || t.due_date);
                return dueDate.toLocaleDateString('en-US', { timeZone: 'America/New_York' }) === todayEST;
            });

            const tasksOverdue = liveData.tasks.filter(t => {
                if (!t.due_on && !t.due_date) return false;
                const dueDate = new Date(t.due_on || t.due_date);
                return dueDate < now;
            });

            // Update task metrics
            document.getElementById('tasks-received-today').textContent = liveData.tasks.length || 0;
            document.getElementById('tasks-due-today').textContent = tasksToday.length || 0;
            document.getElementById('tasks-past-due').textContent = tasksOverdue.length || 0;

            // Count UNPROCESSED (emails WITHOUT "Processed" tag)
            const unprocessedCount = liveData.emails.filter(e =>
                !e.categories || !e.categories.includes('Processed')
            ).length;

            // Count emails by category (ONLY emails WITH "Processed" tag)
            const countByCategory = (categoryName) => {
                return liveData.emails.filter(e =>
                    e.categories &&
                    e.categories.includes('Processed') &&
                    e.categories.includes(categoryName)
                ).length;
            };

            // Count PRIORITY emails (URGENT + Needs Reply + Portfolio CEO_CFO + To: External + Meeting Request External)
            const priorityCategories = ['URGENT', 'Needs Reply', 'Portfolio CEO_CFO', 'To: External', 'Meeting Request External'];
            const priorityCount = liveData.emails.filter(e =>
                e.categories &&
                e.categories.includes('Processed') &&
                priorityCategories.some(cat => e.categories.includes(cat))
            ).length;

            // DEBUG: Show what we're setting
            console.log('üìä Setting email counts:');
            console.log('  UNPROCESSED:', unprocessedCount);
            console.log('  First email sample:', liveData.emails[0]);

            // Update email metrics
            document.getElementById('email-unprocessed').textContent = unprocessedCount || 0;
            document.getElementById('email-urgent-priority').textContent = countByCategory('Urgent/Priority') || 0;
            document.getElementById('email-to-need-response').textContent = countByCategory('To: Need Response/Action') || 0;
            document.getElementById('email-to-fyi').textContent = countByCategory('To: FYI') || 0;
            document.getElementById('email-cc-need-response').textContent = countByCategory('CC: Need Response/Action') || 0;
            document.getElementById('email-cc-fyi').textContent = countByCategory('CC: FYI') || 0;

            // DEBUG: Verify it was set
            console.log('‚úÖ After setting, UNPROCESSED shows:', document.getElementById('email-unprocessed').textContent);

            // Render schedule
            renderSchedule();
        }

        // Render schedule section
        function renderSchedule() {
            const container = document.getElementById('schedule-container');
            if (!container) return;

            if (!liveData || !liveData.calendar || liveData.calendar.length === 0) {
                container.innerHTML = '<div style="padding:1rem;color:var(--text3);text-align:center">No meetings today or tomorrow</div>';
                return;
            }

            // Get today and tomorrow dates in EST
            const nowEST = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const todayEST = nowEST.toLocaleDateString('en-US', { timeZone: 'America/New_York' });

            const tomorrowDate = new Date(nowEST);
            tomorrowDate.setDate(tomorrowDate.getDate() + 1);
            const tomorrowEST = tomorrowDate.toLocaleDateString('en-US', { timeZone: 'America/New_York' });

            // Filter and sort events
            const todayEvents = liveData.calendar.filter(e => {
                const eventDateEST = new Date(e.start).toLocaleDateString('en-US', { timeZone: 'America/New_York' });
                return eventDateEST === todayEST;
            }).sort((a, b) => new Date(a.start) - new Date(b.start));

            const tomorrowEvents = liveData.calendar.filter(e => {
                const eventDateEST = new Date(e.start).toLocaleDateString('en-US', { timeZone: 'America/New_York' });
                return eventDateEST === tomorrowEST;
            }).sort((a, b) => new Date(a.start) - new Date(b.start));

            if (todayEvents.length === 0 && tomorrowEvents.length === 0) {
                container.innerHTML = '<div style="padding:1rem;color:var(--text3);text-align:center">No meetings today or tomorrow</div>';
                return;
            }

            const renderEvent = (event) => {
                // API returns times in UTC - need to convert to EST (UTC-5)
                // Format: "2026-01-15T14:30:00.0000000"
                const timePart = event.start.split('T')[1].split('.')[0]; // "14:30:00"
                const [hours, minutes] = timePart.split(':');
                let hour = parseInt(hours) - 5; // Convert UTC to EST by subtracting 5 hours

                // Handle day rollover
                if (hour < 0) hour += 24;
                if (hour >= 24) hour -= 24;

                const ampm = hour >= 12 ? 'P' : 'A';
                const displayHour = hour === 0 ? 12 : (hour > 12 ? hour - 12 : hour);
                const time = `${displayHour}:${minutes} ${ampm}`;

                // Detect Zoom or Teams meeting links
                const location = event.location || '';
                const body = event.body || '';
                const zoomMatch = (location + ' ' + body).match(/(https:\/\/[^\s]*zoom\.us[^\s]*)/i);
                const teamsMatch = (location + ' ' + body).match(/(https:\/\/teams\.microsoft\.com[^\s]*)/i);

                let joinButton = '';
                if (zoomMatch) {
                    joinButton = '<a href="' + zoomMatch[1] + '" target="_blank" onclick="event.stopPropagation()" style="display:inline-block;margin-top:2px;padding:3px 8px;background:var(--blue);color:#fff;border-radius:4px;font-size:.7rem;font-weight:700;text-decoration:none;min-width:24px;text-align:center">Z</a>';
                } else if (teamsMatch) {
                    joinButton = '<a href="' + teamsMatch[1] + '" target="_blank" onclick="event.stopPropagation()" style="display:inline-block;margin-top:2px;padding:3px 8px;background:var(--purple);color:#fff;border-radius:4px;font-size:.7rem;font-weight:700;text-decoration:none;min-width:24px;text-align:center">T</a>';
                }

                // Add attachment button if meeting has attachments
                let attachmentButton = '';
                if (event.hasAttachments) {
                    const attachmentLink = event.webLink || '#';
                    attachmentButton = '<a href="' + attachmentLink + '" onclick="event.stopPropagation()" style="display:inline-block;margin-top:2px;margin-left:4px;padding:3px 8px;background:var(--text3);color:#fff;border-radius:4px;font-size:.7rem;font-weight:700;text-decoration:none;min-width:24px;text-align:center">üìé</a>';
                }

                // Construct Outlook desktop calendar link
                // Use outlook: protocol for desktop app
                let eventLink = '#';
                if (event.webLink) {
                    // Extract the item ID from webLink and construct outlook:// URL
                    // Format: outlook:calendar?itemid=<id>
                    eventLink = event.webLink;
                } else if (event.id) {
                    // Fallback to constructing from ID
                    eventLink = `https://outlook.office.com/calendar/item/${encodeURIComponent(event.id)}`;
                }

                // Format location with map link
                let locationHtml = '';
                if (event.location) {
                    locationHtml = '<a href="https://maps.google.com/maps?q=' + encodeURIComponent(event.location) + '" target="_blank" onclick="event.stopPropagation()" style="color:var(--text3);text-decoration:none" onmouseover="this.style.textDecoration=\'underline\'" onmouseout="this.style.textDecoration=\'none\'">' + escapeHtml(event.location) + '</a>';
                } else {
                    locationHtml = '<span style="color:var(--text3)">No location</span>';
                }

                return '<div class="item" style="cursor:pointer;transition:background .2s" onmouseover="this.style.background=\'var(--bg2)\'" onmouseout="this.style.background=\'transparent\'" onclick="toggleMeeting(\'' + event.id + '\')">' +
                    '<div class="item-time">' + time + '</div>' +
                    '<div class="item-content">' +
                        '<div class="item-title" style="color:var(--text);text-decoration:none">' + escapeHtml(event.subject) + '</div>' +
                        '<div class="item-meta">' + locationHtml + '</div>' +
                        joinButton + attachmentButton +
                    '</div>' +
                '</div>';
            };

            // Format date labels
            const todayLabel = nowEST.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                timeZone: 'America/New_York'
            });

            const tomorrowLabel = tomorrowDate.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                timeZone: 'America/New_York'
            });

            let html = '';

            // Today section
            if (todayEvents.length > 0) {
                html += '<div style="font-weight:700;font-size:.8rem;color:var(--text);padding:8px 0;border-bottom:2px solid var(--purple);margin-bottom:8px">' + todayLabel + '</div>';
                html += todayEvents.map(renderEvent).join('');
            }

            // Tomorrow section
            if (tomorrowEvents.length > 0) {
                if (todayEvents.length > 0) {
                    html += '<div style="height:1px;background:var(--border);margin:16px 0"></div>';
                }
                html += '<div style="font-weight:700;font-size:.8rem;color:var(--text);padding:8px 0;border-bottom:2px solid var(--purple);margin-bottom:8px">' + tomorrowLabel + '</div>';
                html += tomorrowEvents.map(renderEvent).join('');
            }

            container.innerHTML = html;
            updateAvailability();
        }

        // Update header time display
        function updateHeaderTime() {
            const nowEST = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
            const timeEl = document.getElementById('header-time-display');
            if (timeEl) {
                const hours = nowEST.getHours();
                const minutes = nowEST.getMinutes();
                const ampm = hours >= 12 ? 'P' : 'A';
                const displayHour = hours === 0 ? 12 : (hours > 12 ? hours - 12 : hours);
                timeEl.textContent = `${displayHour}:${minutes.toString().padStart(2, '0')} ${ampm}`;
            }
        }

        // Fetch and display weather
        async function updateWeather() {
            try {
                // Get user's location via IP geolocation
                const locationRes = await fetch('https://ipapi.co/json/');
                const location = await locationRes.json();

                // Fetch weather data
                const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${location.latitude}&longitude=${location.longitude}&current_weather=true&temperature_unit=fahrenheit`);
                const weather = await weatherRes.json();

                const weatherEl = document.getElementById('weather-display');
                if (weatherEl && weather.current_weather) {
                    const temp = Math.round(weather.current_weather.temperature);
                    const weatherCode = weather.current_weather.weathercode;

                    // Weather code to icon mapping
                    let icon = '‚òÄÔ∏è';
                    if (weatherCode >= 61 && weatherCode <= 67) icon = 'üåßÔ∏è';
                    else if (weatherCode >= 71 && weatherCode <= 77) icon = 'üå®Ô∏è';
                    else if (weatherCode >= 80 && weatherCode <= 82) icon = 'üå¶Ô∏è';
                    else if (weatherCode >= 51 && weatherCode <= 57) icon = 'üå¶Ô∏è';
                    else if (weatherCode >= 2 && weatherCode <= 3) icon = '‚õÖ';
                    else if (weatherCode === 45 || weatherCode === 48) icon = 'üå´Ô∏è';
                    else if (weatherCode === 95 || weatherCode === 96 || weatherCode === 99) icon = '‚õàÔ∏è';

                    weatherEl.innerHTML = `<span style="font-size:1.2rem">${icon}</span><span style="font-size:.85rem;font-weight:500;color:var(--text)">${temp}¬∞F</span>`;
                }
            } catch (err) {
                console.error('Error fetching weather:', err);
            }
        }

        // Update current time and availability indicator
        function updateAvailability() {
            const nowEST = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));

            // Update header time
            updateHeaderTime();

            // Update availability indicator
            const indicator = document.getElementById('availability-indicator');
            if (!indicator || !liveData || !liveData.calendar) return;

            const todayEST = nowEST.toLocaleDateString('en-US', { timeZone: 'America/New_York' });
            const todayEvents = liveData.calendar.filter(e => {
                const eventDateEST = new Date(e.start).toLocaleDateString('en-US', { timeZone: 'America/New_York' });
                return eventDateEST === todayEST;
            });

            // Find current or next meeting
            let status = 'free'; // green
            const currentTime = nowEST.getTime();

            for (const event of todayEvents) {
                const eventStart = new Date(event.start);
                const eventEnd = new Date(event.end);

                // Convert to EST
                const startEST = new Date(eventStart.getTime() - (5 * 60 * 60 * 1000));
                const endEST = new Date(eventEnd.getTime() - (5 * 60 * 60 * 1000));

                const minutesUntilStart = (startEST.getTime() - currentTime) / (1000 * 60);
                const minutesUntilEnd = (endEST.getTime() - currentTime) / (1000 * 60);

                // In meeting (blue)
                if (minutesUntilStart <= 0 && minutesUntilEnd > 0) {
                    status = 'in-meeting';
                    break;
                }
                // Meeting within 5 minutes (orange)
                else if (minutesUntilStart > 0 && minutesUntilStart <= 5) {
                    status = 'meeting-very-soon';
                    break;
                }
                // Meeting within 15 minutes (yellow)
                else if (minutesUntilStart > 5 && minutesUntilStart <= 15) {
                    status = 'meeting-soon';
                    break;
                }
            }

            // Update indicator class and tooltip
            indicator.className = 'availability-indicator';
            if (status === 'meeting-soon') {
                indicator.classList.add('meeting-soon');
                indicator.title = 'Meeting within 15 minutes';
            } else if (status === 'meeting-very-soon') {
                indicator.classList.add('meeting-very-soon');
                indicator.title = 'Meeting within 5 minutes';
            } else if (status === 'in-meeting') {
                indicator.classList.add('in-meeting');
                indicator.title = 'Currently in a meeting';
            } else {
                indicator.title = 'Available - No upcoming meetings';
            }
        }

        // Update time and availability every 30 seconds
        setInterval(updateAvailability, 30000);

        // Format time ago
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(hours / 24);

            if (hours < 1) return 'Just now';
            if (hours < 24) return hours + 'h ago';
            if (days < 7) return days + 'd ago';
            return date.toLocaleDateString();
        }


        function logout() {
            localStorage.removeItem('abbi_auth');
            location.reload();
        }

        // Manual Email Refresh - Triggers triage webhook
        async function manualRefreshEmails() {
            const btn = document.getElementById('refresh-emails-btn');
            const icon = document.getElementById('refresh-icon');
            const text = document.getElementById('refresh-text');

            // Disable button and show loading state
            btn.disabled = true;
            icon.innerHTML = '<span class="spinner">‚ü≥</span>';
            text.textContent = 'Loading...';

            try {
                console.log('üîÑ Manual refresh triggered - reloading data...');
                await fetchLiveData();

                // Show success message
                icon.textContent = '‚úÖ';
                text.textContent = 'Refreshed';

                // Reset button after 2 seconds
                setTimeout(() => {
                    btn.disabled = false;
                    icon.textContent = 'üîÑ';
                    text.textContent = 'Refresh Emails';
                }, 2000);

            } catch (error) {
                console.error('‚ùå Manual refresh error:', error);

                // Show error message
                icon.textContent = '‚ùå';
                text.textContent = 'Refresh failed';

                // Re-enable button after 3 seconds
                setTimeout(() => {
                    btn.disabled = false;
                    icon.textContent = 'üîÑ';
                    text.textContent = 'Refresh Emails';
                }, 3000);
            }
        }

        // Time filter
        // Toggle left pane
        function toggleLeftPane() {
            leftPaneCollapsed = !leftPaneCollapsed;
            const leftPane = document.getElementById('leftPane');
            const container = document.getElementById('dashboardContainer');
            const icon = document.getElementById('leftToggleIcon');

            leftPane.classList.toggle('collapsed');
            icon.textContent = leftPaneCollapsed ? '‚ñ∂' : '‚óÄ';

            // Update container class
            if (leftPaneCollapsed && rightPaneCollapsed) {
                container.className = 'dashboard-container both-collapsed';
            } else if (leftPaneCollapsed) {
                container.className = 'dashboard-container left-collapsed';
            } else if (rightPaneCollapsed) {
                container.className = 'dashboard-container right-collapsed';
            } else {
                container.className = 'dashboard-container';
            }
        }

        // Toggle right pane
        function toggleRightPane() {
            rightPaneCollapsed = !rightPaneCollapsed;
            const rightPane = document.getElementById('rightPane');
            const container = document.getElementById('dashboardContainer');
            const icon = document.getElementById('rightToggleIcon');

            rightPane.classList.toggle('collapsed');
            icon.textContent = rightPaneCollapsed ? '‚óÄ' : '‚ñ∂';

            // Update container class
            if (leftPaneCollapsed && rightPaneCollapsed) {
                container.className = 'dashboard-container both-collapsed';
            } else if (leftPaneCollapsed) {
                container.className = 'dashboard-container left-collapsed';
            } else if (rightPaneCollapsed) {
                container.className = 'dashboard-container right-collapsed';
            } else {
                container.className = 'dashboard-container';
            }
        }

        // Toggle metric card collapse/expand (left pane)
        function toggleMetricCard(cardId) {
            const card = document.getElementById(cardId);
            const content = card.querySelector('.metric-card-content');
            const icon = card.querySelector('.collapse-icon');

            content.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');

            // Save state to localStorage
            const isCollapsed = content.classList.contains('collapsed');
            localStorage.setItem(`${cardId}-collapsed`, isCollapsed);
        }

        // Toggle section card collapse/expand (right pane)
        function toggleSectionCard(cardId) {
            const card = document.getElementById(cardId);
            const content = card.querySelector('.section-content-wrapper');
            const icon = card.querySelector('.collapse-icon');

            content.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');

            // Save state to localStorage
            const isCollapsed = content.classList.contains('collapsed');
            localStorage.setItem(`${cardId}-collapsed`, isCollapsed);
        }

        // Restore collapse states on page load
        function restoreCollapseStates() {
            // Restore metric cards (left pane)
            const metricCards = ['email-card', 'tasks-card', 'asana-card'];
            metricCards.forEach(cardId => {
                const isCollapsed = localStorage.getItem(`${cardId}-collapsed`) === 'true';
                if (isCollapsed) {
                    const card = document.getElementById(cardId);
                    const content = card.querySelector('.metric-card-content');
                    const icon = card.querySelector('.collapse-icon');
                    content.classList.add('collapsed');
                    icon.classList.add('collapsed');
                }
            });

            // Restore section cards (right pane)
            const sectionCards = ['calendar-card', 'portfolio-card', 'abbi-card'];
            sectionCards.forEach(cardId => {
                const isCollapsed = localStorage.getItem(`${cardId}-collapsed`) === 'true';
                if (isCollapsed) {
                    const card = document.getElementById(cardId);
                    const content = card.querySelector('.section-content-wrapper');
                    const icon = card.querySelector('.collapse-icon');
                    content.classList.add('collapsed');
                    icon.classList.add('collapsed');
                }
            });
        }

        // Toggle email expand/collapse and show in center pane
        async function toggleEmail(emailId) {
            if (expandedEmailId === emailId) {
                expandedEmailId = null;

                // Restore title based on current view
                const titles = {
                    'tasks-received': 'Tasks Received Today',
                    'tasks-due': 'Tasks Due Today',
                    'tasks-overdue': 'Past Due Tasks',
                    'email-unprocessed': 'UNPROCESSED Emails',
                    'email-urgent': 'URGENT Emails',
                    'email-investor': 'Investor Emails',
                    'email-portfolio-ceo-cfo': 'Portfolio CEO_CFO Emails',
                    'email-needs-reply': 'Needs Reply',
                    'email-to-external': 'To: External',
                    'email-to-internal': 'To: Internal',
                    'email-cc-external': 'CC: External',
                    'email-cc-internal': 'CC: Internal',
                    'email-meeting-internal': 'Meeting Request: Internal',
                    'email-meeting-external': 'Meeting Request: External',
                    'email-fyi': 'FYI'
                };
                document.getElementById('view-title').textContent = titles[currentView] || 'Dashboard';

                renderContent(); // Go back to email list
            } else {
                expandedEmailId = emailId;
                renderExpandedEmail();

                // Auto-mark as read based on v6.2 protocol rules
                autoMarkEmailRead(emailId, currentView);

                // Only process with AI if email is not already triaged
                const email = liveData.emails.find(e => e.id === emailId);
                const isTriaged = email && email.summary && email.priority && email.classification;

                if (!isTriaged) {
                    // Automatically process with AI (non-blocking) - only for non-triaged emails
                    processEmailWithAI(emailId, true).catch(err => {
                        console.error('AI processing failed:', err);
                    });
                }
            }
        }

        // Get filtered email list based on current view
        function getFilteredEmailList() {
            if (!liveData || !liveData.emails) return [];

            let filtered = liveData.emails;

            // Special case: "UNPROCESSED" = emails WITHOUT "Processed" tag
            if (currentView === 'email-unprocessed') {
                filtered = filtered.filter(e =>
                    !e.categories || !e.categories.includes('Processed')
                );
                return filtered;
            }

            // Filter by Outlook category tags (ONLY emails WITH "Processed" tag)
            const categoryMapping = {
                'email-urgent': 'URGENT',
                'email-investor': 'Investor',
                'email-portfolio-ceo-cfo': 'Portfolio CEO_CFO',
                'email-needs-reply': 'Needs Reply',
                'email-to-external': 'To: External',
                'email-to-internal': 'To: Internal',
                'email-cc-external': 'CC: External',
                'email-cc-internal': 'CC: Internal',
                'email-meeting-internal': 'Meeting Request Internal',
                'email-meeting-external': 'Meeting Request External',
                'email-fyi': 'FYI'
            };

            const categoryName = categoryMapping[currentView];
            if (categoryName) {
                filtered = filtered.filter(e =>
                    e.categories &&
                    e.categories.includes('Processed') &&
                    e.categories.includes(categoryName)
                );
            }

            return filtered;
        }

        // Navigate to previous email
        function navigateToPreviousEmail() {
            const filteredEmails = getFilteredEmailList();
            const currentIndex = filteredEmails.findIndex(e => e.id === expandedEmailId);
            if (currentIndex > 0) {
                expandedEmailId = filteredEmails[currentIndex - 1].id;
                renderExpandedEmail();
                autoMarkEmailRead(expandedEmailId, currentView);
                processEmailWithAI(expandedEmailId, true).catch(err => {
                    console.error('AI processing failed:', err);
                });
            }
        }

        // Navigate to next email
        function navigateToNextEmail() {
            const filteredEmails = getFilteredEmailList();
            const currentIndex = filteredEmails.findIndex(e => e.id === expandedEmailId);
            if (currentIndex < filteredEmails.length - 1) {
                expandedEmailId = filteredEmails[currentIndex + 1].id;
                renderExpandedEmail();
                autoMarkEmailRead(expandedEmailId, currentView);
                processEmailWithAI(expandedEmailId, true).catch(err => {
                    console.error('AI processing failed:', err);
                });
            }
        }

        // Toggle original email view (fetch and display)
        async function toggleOriginalEmail(emailId) {
            const container = document.getElementById(`original-email-${emailId}`);
            const icon = document.getElementById(`email-toggle-icon-${emailId}`);

            if (container.style.display === 'none') {
                // Show and fetch if not already loaded
                container.style.display = 'block';
                icon.textContent = '‚ñ≤';

                // Check if already loaded
                if (container.dataset.loaded !== 'true') {
                    try {
                        // Fetch original email from Outlook
                        const email = liveData.emails.find(e => e.id === emailId);
                        const response = await fetch('/api/email/get-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                message_id: email.outlook_message_id || emailId,
                                user: 'jstewart@middleground.com'
                            })
                        });

                        if (!response.ok) {
                            throw new Error('Failed to fetch email');
                        }

                        const data = await response.json();
                        const emailBody = data.body || data.bodyPreview || 'No email content available';

                        // Format and display
                        const formattedBody = escapeHtml(emailBody).replace(/\n/g, '<br>');
                        container.innerHTML = `<div style="color:var(--text);font-size:.9rem;line-height:1.6">${formattedBody}</div>`;
                        container.dataset.loaded = 'true';

                    } catch (error) {
                        console.error('Error fetching original email:', error);
                        container.innerHTML = `<div style="color:var(--red)">Error loading email: ${error.message}</div>`;
                    }
                }
            } else {
                // Hide
                container.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        // Auto-mark email as read following v6.2 protocol
        async function autoMarkEmailRead(emailId, viewOrMailbox, explicitMailbox = null) {
            // DISABLED: Auto-flagging removed - user will manually flag if needed
            // High-priority categories no longer auto-flag emails
            const highPriorityCategories = [];

            // Determine mailbox: use explicitMailbox if provided, otherwise check if viewOrMailbox looks like an email
            const mailbox = explicitMailbox || (viewOrMailbox?.includes('@') ? viewOrMailbox : 'jstewart@middleground.com');

            const isHighPriority = false; // DISABLED: No auto-flagging

            try {
                // Always mark as read
                await fetch('/api/email/mark-read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message_ids: [emailId],
                        user: mailbox,
                        is_read: true
                    })
                });

                if (isHighPriority) {
                    // Flag high-priority emails for follow-up
                    await fetch('/api/email/flag-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message_ids: [emailId],
                            user: mailbox,
                            flag_status: 'flagged'
                        })
                    });
                    console.log(`‚úì Email ${emailId} marked as read and FLAGGED (high priority) for ${mailbox}`);
                } else {
                    console.log(`‚úì Email ${emailId} marked as read for ${mailbox}`);
                }

                // MARK EMAIL AS PROCESSED in Snowflake cache
                try {
                    await fetch('/api/email/mark-processed', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email_id: emailId })
                    });
                    console.log(`‚úì Email ${emailId} marked as processed in cache`);

                    // Remove from local memory and update UI
                    if (window.allBriefingEmails) {
                        const emailIndex = window.allBriefingEmails.findIndex(e => e.id === emailId);
                        if (emailIndex !== -1) {
                            console.log(`üóëÔ∏è Removing processed email ${emailId} from dashboard view`);
                            window.allBriefingEmails.splice(emailIndex, 1);

                            // Update sidebar counts and re-render email list
                            updateSidebarCounts();
                            renderEmailList();

                            // If this was the expanded email, move to next or close
                            if (expandedEmailId === emailId) {
                                if (window.allBriefingEmails.length > 0) {
                                    // Move to next email (or first if we were at the end)
                                    const nextEmail = window.allBriefingEmails[emailIndex] || window.allBriefingEmails[0];
                                    expandedEmailId = nextEmail.id;
                                    renderExpandedEmail();
                                    autoMarkEmailRead(expandedEmailId, currentView);
                                } else {
                                    // No more emails - return to briefing view
                                    expandedEmailId = null;
                                    switchView('daily-briefing');
                                }
                            }
                        }
                    }
                } catch (markError) {
                    console.error('Error marking email as processed:', markError);
                }
            } catch (error) {
                console.error('Error auto-marking email as read:', error);
            }
        }

        // Unflag email when processed/actioned
        async function unflagEmail(emailId, mailbox) {
            try {
                await fetch('/api/email/flag-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message_ids: [emailId],
                        user: mailbox || 'jstewart@middleground.com',
                        flag_status: 'notFlagged'
                    })
                });
                console.log(`‚úì Email ${emailId} unflagged (processed)`);
            } catch (error) {
                console.error('Error unflagging email:', error);
            }
        }

        // Update sidebar counts after email removal
        function updateSidebarCounts() {
            if (!window.allBriefingEmails) return;

            // Count by category
            const emailsByCategory = {
                'Urgent/Priority': [],
                'To: Need Response/Action': [],
                'To: FYI': [],
                'CC: Need Response/Action': [],
                'CC: FYI': []
            };

            window.allBriefingEmails.forEach(email => {
                const category = email.category || 'To: FYI';
                if (emailsByCategory[category]) {
                    emailsByCategory[category].push(email);
                }
            });

            // Update sidebar
            document.getElementById('email-urgent-priority').textContent = emailsByCategory['Urgent/Priority'].length;
            document.getElementById('email-to-need-response').textContent = emailsByCategory['To: Need Response/Action'].length;
            document.getElementById('email-to-fyi').textContent = emailsByCategory['To: FYI'].length;
            document.getElementById('email-cc-need-response').textContent = emailsByCategory['CC: Need Response/Action'].length;
            document.getElementById('email-cc-fyi').textContent = emailsByCategory['CC: FYI'].length;
        }

        // Re-render email list after removal (if viewing filtered category)
        function renderEmailList() {
            // If we're viewing a category in the daily briefing, refresh it
            if (currentView === 'daily-briefing' && window.currentBriefingCategory) {
                filterBriefingByCategory(window.currentBriefingCategory);
            }
        }

        // Filter briefing emails by category and display
        function filterBriefingByCategory(category) {
            if (!window.allBriefingEmails) return;

            window.currentBriefingCategory = category;
            const container = document.getElementById('content');
            if (!container) return;

            // Filter emails by category
            const filteredEmails = window.allBriefingEmails.filter(email => {
                return email.category === category;
            });

            // Render filtered list
            let html = '<div style="padding:20px">';
            html += `<h2 style="margin-bottom:20px">${category} (${filteredEmails.length})</h2>`;

            if (filteredEmails.length === 0) {
                html += '<div style="color:var(--text2);padding:20px;text-align:center">No emails in this category</div>';
            } else {
                filteredEmails.forEach(email => {
                    html += `<div onclick="processEmail('${email.id}')" style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='var(--bg2)'" onmouseout="this.style.background='var(--card)'">`;
                    html += `<div style="font-weight:600;margin-bottom:4px">${escapeHtml(email.subject || 'No subject')}</div>`;
                    html += `<div style="font-size:.8rem;color:var(--text2)">From: ${escapeHtml(email.from)} ‚Ä¢ ${email.folder || 'Inbox'}</div>`;
                    html += '</div>';
                });
            }

            html += '<button onclick="switchView(\'daily-briefing\')" style="margin-top:20px;padding:10px 20px;background:var(--purple);color:white;border:none;border-radius:6px;cursor:pointer">‚Üê Back to All Categories</button>';
            html += '</div>';

            container.innerHTML = html;
        }

        // Process all emails with AI triage
        async function processAllEmails() {
            try {
            console.log('=== PROCESS ALL CLICKED ===');
            console.log('Total emails in liveData:', liveData.emails?.length || 0);
            console.log('Sample email structure:', liveData.emails?.[0]);

            // Get all emails WITHOUT "Processed" tag
            const unprocessedEmails = (liveData.emails || []).filter(e =>
                !e.categories || !e.categories.includes('Processed')
            );

            console.log('Unprocessed emails found:', unprocessedEmails.length);
            console.log('Sample unprocessed email:', unprocessedEmails[0]);

            if (unprocessedEmails.length === 0) {
                alert('‚úÖ No unprocessed emails found!\n\nAll your emails have already been processed with AI.');
                return;
            }

            // Show alert before confirm so user knows something is happening
            const btn = event?.target;
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Checking...';
            }

            if (!confirm(`AI Email Processing\n\nFound ${unprocessedEmails.length} emails to process.\n\nThis will:\n‚úì Analyze each email with AI\n‚úì Apply categories (URGENT, Needs Reply, etc.)\n‚úì Set read/unread status\n‚úì Take ~${Math.max(1, Math.ceil(unprocessedEmails.length / 10))} minutes (10 at a time)\n\nContinue?`)) {
                console.log('User cancelled process all');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'üîÑ';
                }
                return;
            }

            if (btn) {
                btn.innerHTML = '‚è≥';
            }

            console.log('User confirmed - starting batch processing...');

            const totalCount = unprocessedEmails.length;
            let processedCount = 0;
            let successCount = 0;
            let failedCount = 0;

            console.log(`Starting batch processing of ${totalCount} emails...`);

            // v8.43: Process emails in parallel batches for speed (10 at a time)
            const BATCH_SIZE = 10;
            for (let i = 0; i < unprocessedEmails.length; i += BATCH_SIZE) {
                const batch = unprocessedEmails.slice(i, i + BATCH_SIZE);
                console.log(`Processing batch ${Math.floor(i/BATCH_SIZE) + 1}: ${batch.length} emails`);

                // Update button with progress
                if (btn) {
                    btn.innerHTML = `‚è≥ ${i}/${totalCount}`;
                }

                // Process all emails in this batch in parallel
                const batchResults = await Promise.allSettled(
                    batch.map(email => processEmailWithAI(email.id, true))
                );

                // Count successes and failures
                batchResults.forEach((result, idx) => {
                    processedCount++;
                    if (result.status === 'fulfilled') {
                        successCount++;
                        console.log(`‚úÖ Processed ${processedCount}/${totalCount}: ${batch[idx].subject}`);
                    } else {
                        failedCount++;
                        console.error(`‚ùå Failed ${processedCount}/${totalCount}:`, result.reason);
                    }
                });

                // Small delay between batches only
                if (i + BATCH_SIZE < unprocessedEmails.length) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            // Reset button
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = 'üîÑ';
            }

            // Refresh dashboard data
            await fetchLiveData();

            alert(`‚úÖ Batch processing complete!\n\nProcessed: ${totalCount}\nSuccess: ${successCount}\nFailed: ${failedCount}\n\nDashboard has been refreshed.`);

            } catch (error) {
                console.error('‚ùå FATAL ERROR in processAllEmails:', error);
                alert(`‚ùå Fatal Error\n\n${error.message}\n\nCheck console for details.`);

                // Try to reset button
                const btn = document.querySelector('button[onclick*="processAllEmails"]');
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'üîÑ';
                }
            }
        }

        // Process email with AI triage
        async function processEmailWithAI(emailId, isAuto = false) {
            try {
                // Show loading state on button if manual trigger
                let btn, originalText;
                if (!isAuto && event && event.target) {
                    btn = event.target;
                    originalText = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<span style="opacity:0.6">AI Processing...</span>';
                }

                // Show loading state in AI analysis card
                const topicEl = document.getElementById(`topic-${emailId}`);
                if (topicEl) topicEl.innerHTML = '<span style="opacity:0.5">Processing...</span>';

                // Find the email
                const email = liveData.emails.find(e => e.id === emailId);
                if (!email) {
                    console.error('Email not found for AI processing');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                    return;
                }

                // Debug: Log email structure to understand M365 field names
                console.log('Email object for AI processing:', email);
                console.log('Email fields:', Object.keys(email));

                // Build request body with proper M365 field mapping
                // v8.33: Don't send body - let backend fetch full email via m365_get_email
                const requestBody = {
                    message_id: emailId || email.id,
                    user: 'jstewart@middleground.com',  // This dashboard is for jstewart
                    from: email.from?.emailAddress?.name || email.from_name || email.from || email.sender?.emailAddress?.name || 'Unknown',
                    subject: email.subject || 'No subject',
                    // body omitted - backend will fetch full email
                    category: currentView
                };

                console.log('Sending to process-triage API:', requestBody);
                console.log('Email object preview:', {
                    id: email.id,
                    subject: email.subject,
                    preview: email.preview?.substring(0, 100),
                    bodyPreview: email.bodyPreview?.substring(0, 100),
                    hasBody: !!email.body
                });

                // Call AI triage API with timeout
                let response, result;
                try {
                    // v8.38: Add 65 second timeout (slightly longer than backend 60s)
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 65000);

                    try {
                        response = await fetch('/api/email/process-triage', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        console.log('Response status:', response.status);

                        result = await response.json();
                        console.log('API response:', result);
                    } catch (fetchError) {
                        clearTimeout(timeoutId);
                        if (fetchError.name === 'AbortError') {
                            throw new Error('Request timed out after 65 seconds - email may be too large or system is slow');
                        }
                        throw fetchError;
                    }
                } catch (fetchError) {
                    console.error('Fetch error:', fetchError);
                    const errorMsg = `Network error: ${fetchError.message}`;
                    if (!isAuto) {
                        alert(`‚ùå Processing failed:\n\n${errorMsg}\n\nCheck console for details.`);
                    }
                    throw new Error(errorMsg);
                }

                if (!response.ok || !result.success) {
                    const errorMsg = result.error || `API request failed with status ${response.status}`;
                    console.error('API Error:', errorMsg);
                    if (!isAuto) {
                        alert(`‚ùå Processing failed:\n\n${errorMsg}\n\nCheck console for details.`);
                    }
                    throw new Error(errorMsg);
                }

                if (result.success) {
                    const analysis = result.data;

                    // Update the displayed content with AI results
                    const topicEl = document.getElementById(`topic-${emailId}`);
                    const summaryEl = document.getElementById(`summary-${emailId}`);
                    const requestingEl = document.getElementById(`requesting-${emailId}`);
                    const actionItemsEl = document.getElementById(`actionItems-${emailId}`);
                    const yourActionEl = document.getElementById(`yourAction-${emailId}`);

                    if (topicEl) topicEl.textContent = analysis.topic || 'General Communication';
                    if (summaryEl) summaryEl.textContent = analysis.summary || 'No summary available';
                    if (requestingEl) requestingEl.textContent = analysis.requesting || 'No specific request';
                    if (actionItemsEl) actionItemsEl.textContent = analysis.actionItems || 'No action items';
                    if (yourActionEl) yourActionEl.textContent = analysis.yourAction || 'Review for awareness';

                    // Update suggested response
                    const responseEditor = document.getElementById(`responseEditor-${emailId}`);
                    if (responseEditor && analysis.suggestedResponse) {
                        responseEditor.value = analysis.suggestedResponse;
                    }

                    // Update forward suggestion
                    const forwardMessage = document.getElementById(`forwardMessage-${emailId}`);
                    if (forwardMessage && analysis.forwardSuggestion) {
                        forwardMessage.value = analysis.forwardSuggestion;
                    }

                    // Update recommended plan if available
                    const recommendedPlanEl = document.getElementById(`recommended-plan-${emailId}`);
                    if (recommendedPlanEl && analysis.recommendedPlan) {
                        const plan = analysis.recommendedPlan;
                        let html = '';

                        // Decision
                        html += `<div style="margin-bottom:16px">`;
                        html += `<div style="font-weight:700;color:var(--purple);margin-bottom:8px">RECOMMENDED DECISION:</div>`;
                        html += `<div style="font-size:.95rem;color:var(--text);margin-bottom:8px">${plan.decision || 'No specific decision'}</div>`;
                        if (plan.reasoning) {
                            html += `<div style="font-size:.85rem;color:var(--text3);font-style:italic">${plan.reasoning}</div>`;
                        }
                        html += `</div>`;

                        // Contact Info Needed - Prominent Alert
                        if (plan.needsContactInfo) {
                            html += `<div style="margin-bottom:16px;background:rgba(245,158,11,.15);border:2px solid var(--amber);border-radius:8px;padding:12px">`;
                            html += `<div style="font-weight:700;color:var(--amber);margin-bottom:6px">‚ö†Ô∏è CONTACT INFORMATION NEEDED:</div>`;
                            html += `<div style="font-size:.9rem;color:var(--text)">${plan.needsContactInfo}</div>`;
                            html += `<div style="font-size:.8rem;color:var(--text3);margin-top:6px;font-style:italic">Provide this information in the command prompt below to proceed with execution.</div>`;
                            html += `</div>`;
                        }

                        // Drafted emails
                        if (plan.emails && plan.emails.length > 0) {
                            html += `<div style="margin-bottom:16px">`;
                            html += `<div style="font-weight:700;color:var(--text);margin-bottom:8px">üìß DRAFTED EMAILS (${plan.emails.length}):</div>`;

                            plan.emails.forEach((email, idx) => {
                                const needsContact = email.to.join(', ').includes('NEED_CONTACT_INFO');
                                const borderColor = needsContact ? 'var(--amber)' : 'var(--purple)';
                                const bgColor = needsContact ? 'rgba(245,158,11,.1)' : 'var(--bg2)';

                                html += `<div style="background:${bgColor};padding:12px;border-radius:6px;margin-bottom:10px;border-left:3px solid ${borderColor}">`;
                                html += `<div style="font-weight:600;font-size:.9rem;margin-bottom:6px">#${idx + 1} ‚Üí ${email.to.join(', ')}</div>`;
                                if (email.cc && email.cc.length > 0) {
                                    html += `<div style="font-size:.85rem;color:var(--text3);margin-bottom:6px">CC: ${email.cc.join(', ')}</div>`;
                                }
                                if (email.note && needsContact) {
                                    html += `<div style="font-size:.85rem;color:var(--amber);margin-bottom:6px;font-weight:600">‚ö†Ô∏è ${email.note}</div>`;
                                }
                                html += `<div style="font-weight:600;font-size:.9rem;margin-bottom:8px">Subject: ${email.subject}</div>`;
                                html += `<div style="white-space:pre-wrap;font-size:.85rem;color:var(--text2);padding:10px;background:var(--bg);border-radius:4px;margin-bottom:6px">${escapeHtml(email.body)}</div>`;
                                if (email.why) {
                                    html += `<div style="font-size:.8rem;color:var(--text3);font-style:italic">${email.why}</div>`;
                                }
                                html += `</div>`;
                            });
                            html += `</div>`;
                        }

                        // Tracking items
                        if (plan.tracking && plan.tracking.length > 0) {
                            html += `<div style="margin-bottom:16px">`;
                            html += `<div style="font-weight:700;color:var(--text);margin-bottom:8px">üìÖ TRACKING:</div>`;
                            plan.tracking.forEach(item => {
                                html += `<div style="font-size:.85rem;color:var(--text2);padding:6px;background:var(--bg2);border-radius:4px;margin-bottom:4px">‚Ä¢ ${item}</div>`;
                            });
                            html += `</div>`;
                        }

                        // Follow-up actions
                        if (plan.followUp && plan.followUp.length > 0) {
                            html += `<div>`;
                            html += `<div style="font-weight:700;color:var(--text);margin-bottom:8px">‚úÖ FOLLOW-UP:</div>`;
                            plan.followUp.forEach(action => {
                                html += `<div style="font-size:.85rem;color:var(--text2);padding:6px;background:var(--bg2);border-radius:4px;margin-bottom:4px">‚Ä¢ ${action}</div>`;
                            });
                            html += `</div>`;
                        }

                        recommendedPlanEl.innerHTML = html;
                    } else if (recommendedPlanEl) {
                        recommendedPlanEl.innerHTML = '<div style="font-style:italic;color:var(--text3)">No action plan generated yet. Click "Re-process with AI" to generate.</div>';
                    }

                    // Show category warning if present
                    if (result.categoryWarning) {
                        console.warn('‚ö†Ô∏è Category Warning:', result.categoryWarning);
                        if (!isAuto) {
                            alert(`‚ö†Ô∏è ${result.categoryWarning}`);
                        }
                    }

                    // Show success feedback on button if manual
                    if (btn) {
                        btn.innerHTML = '‚úì AI Processed';
                        setTimeout(() => {
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                        }, 2000);
                    }
                } else {
                    console.error('AI processing failed:', result.error);
                    console.error('Full response:', result);
                    const errorMsg = `AI processing failed: ${result.error || 'Unknown error'}`;
                    if (!isAuto) alert(errorMsg);
                    if (topicEl) topicEl.innerHTML = `<span style="color:var(--red)">${errorMsg}</span>`;
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                }
            } catch (error) {
                console.error('Error processing email with AI:', error);
                if (!isAuto) alert(`Error: ${error.message}`);
                if (!isAuto && event && event.target) {
                    event.target.disabled = false;
                    event.target.innerHTML = 'üîÑ Re-process with AI';
                }
            }
        }

        // Manually mark email as read and close
        async function markEmailReadAndClose(emailId) {
            try {
                // Show loading state
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<span style="opacity:0.6">Marking as read...</span>';

                // Mark as read via API
                const response = await fetch('/api/email/mark-read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message_ids: [emailId],
                        user: 'john@middleground.com',
                        is_read: true
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Unflag the email (processed/actioned)
                    await unflagEmail(emailId, 'john@middleground.com');

                    // Close expanded view and return to list
                    expandedEmailId = null;

                    // Restore title
                    const titles = {
                        'tasks-received': 'Tasks Received Today',
                        'tasks-due': 'Tasks Due Today',
                        'tasks-overdue': 'Past Due Tasks',
                        'email-unprocessed': 'UNPROCESSED Emails',
                        'email-urgent': 'URGENT Emails',
                        'email-investor': 'Investor Emails',
                        'email-portfolio-ceo-cfo': 'Portfolio CEO_CFO Emails',
                        'email-needs-reply': 'Needs Reply',
                        'email-to-external': 'To: External',
                        'email-to-internal': 'To: Internal',
                        'email-cc-external': 'CC: External',
                        'email-cc-internal': 'CC: Internal',
                        'email-meeting-internal': 'Meeting Request: Internal',
                        'email-meeting-external': 'Meeting Request: External',
                        'email-fyi': 'FYI'
                    };
                    document.getElementById('view-title').textContent = titles[currentView] || 'Dashboard';

                    // Refresh the email list to remove marked email
                    await fetchLiveData();
                    renderContent();
                } else {
                    alert(`Failed to mark as read: ${result.error}`);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Error marking email as read:', error);
                alert(`Error: ${error.message}`);
            }
        }

        // Render expanded email with three columns
        function renderExpandedEmail() {
            const container = document.getElementById('contentList');
            if (!liveData || !liveData.emails) {
                container.innerHTML = '<div class="no-selection"><p>Email not found</p></div>';
                return;
            }

            const email = liveData.emails.find(e => e.id === expandedEmailId);
            if (!email) {
                container.innerHTML = '<div class="no-selection"><p>Email not found</p></div>';
                return;
            }

            // Get filtered email list for navigation
            const filteredEmails = getFilteredEmailList();
            const currentIndex = filteredEmails.findIndex(e => e.id === expandedEmailId);
            const hasPrevious = currentIndex > 0;
            const hasNext = currentIndex < filteredEmails.length - 1;
            const emailPosition = `${currentIndex + 1} of ${filteredEmails.length}`;

            const from = email.from_name || email.from || 'Unknown';
            const subject = email.subject || '(No subject)';
            const date = formatEmailTime(email.received_at || email.date || email.receivedDateTime);
            const fullDate = email.received_at || email.date || email.receivedDateTime ? new Date(email.received_at || email.date || email.receivedDateTime).toLocaleString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : 'Unknown date';

            // Extract TO recipients (if multiple)
            let toRecipientsHTML = '';
            if (email.toRecipients && Array.isArray(email.toRecipients) && email.toRecipients.length > 0) {
                const toList = email.toRecipients.map(r => {
                    const name = r.emailAddress?.name || r.emailAddress?.address || r.name || r.address || 'Unknown';
                    const addr = r.emailAddress?.address || r.address || '';
                    return name + (addr && name !== addr ? ` <${addr}>` : '');
                }).join(', ');
                if (email.toRecipients.length > 1 || toList !== from) {
                    toRecipientsHTML = `<div class="email-detail-from" style="color:var(--text2);font-size:.75rem">To: ${escapeHtml(toList)}</div>`;
                }
            }

            // Extract CC recipients
            let ccRecipientsHTML = '';
            if (email.ccRecipients && Array.isArray(email.ccRecipients) && email.ccRecipients.length > 0) {
                const ccList = email.ccRecipients.map(r => {
                    const name = r.emailAddress?.name || r.emailAddress?.address || r.name || r.address || 'Unknown';
                    const addr = r.emailAddress?.address || r.address || '';
                    return name + (addr && name !== addr ? ` <${addr}>` : '');
                }).join(', ');
                ccRecipientsHTML = `<div class="email-detail-from" style="color:var(--text2);font-size:.75rem">CC: ${escapeHtml(ccList)}</div>`;
            }

            // Show attachments if present
            let attachmentsHTML = '';
            if (email.hasAttachments) {
                const attachmentCount = email.attachments?.length || 'some';
                const attachmentNames = email.attachments && Array.isArray(email.attachments)
                    ? email.attachments.map(a => a.name || 'Unnamed file').join(', ')
                    : 'files attached';
                attachmentsHTML = `<div class="email-detail-from" style="color:var(--purple);font-size:.75rem">üìé Attachments: ${escapeHtml(attachmentNames)}</div>`;
            }

            // Generate AI Summary (placeholder - will be replaced with real AI)
            const aiSummary = generateAISummary(email);
            const suggestedResponse = generateSuggestedResponse(email);

            // Check if email is triaged
            const isTriaged = email.summary && email.priority && email.classification;

            // Generate recommended action plan content
            let recommendedPlanHTML;
            if (isTriaged) {
                if (email.tag === 'Needs Response') {
                    recommendedPlanHTML = `
                        <div style="background:var(--bg);border:2px solid var(--red);border-radius:8px;padding:12px;margin-bottom:10px">
                            <div style="color:var(--red);font-weight:bold;margin-bottom:8px">‚ö° ACTION REQUIRED</div>
                            <div style="color:var(--text)">This email requires a response or action from you.</div>
                            ${email.action_items && email.action_items.length > 0 ? `
                                <div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
                                    <strong>Action Items:</strong>
                                    <ul style="margin:4px 0;padding-left:20px">
                                        ${email.action_items.map(item => `<li>${escapeHtml(item)}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                } else {
                    recommendedPlanHTML = `
                        <div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:10px">
                            <div style="color:var(--text3);font-weight:bold;margin-bottom:8px">üìã FYI - No Action Required</div>
                            <div style="color:var(--text2)">This email is for your information only. No response needed.</div>
                        </div>
                    `;
                }
            } else {
                recommendedPlanHTML = `
                    <div style="background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:10px">
                        <div style="font-style:italic;color:var(--text3)">Processing email with AI to generate action plan...</div>
                    </div>
                `;
            }

            document.getElementById('view-title').textContent = 'Email: ' + subject;

            container.innerHTML = `
                <div class="email-expanded-view">
                    <!-- Email Navigation Bar -->
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;margin-bottom:6px">
                        <button class="response-btn" onclick="navigateToPreviousEmail()" ${!hasPrevious ? 'disabled style="opacity:0.3;cursor:not-allowed"' : ''}>
                            ‚Üê Previous
                        </button>
                        <span style="font-size:.9rem;color:var(--text2);font-weight:500">Email ${emailPosition}</span>
                        <button class="response-btn" onclick="navigateToNextEmail()" ${!hasNext ? 'disabled style="opacity:0.3;cursor:not-allowed"' : ''}>
                            Next ‚Üí
                        </button>
                    </div>

                    <!-- Card 1: Email Metadata -->
                    <div class="email-card">
                        <div class="email-card-title">EMAIL METADATA</div>
                        <div class="email-detail-header">
                            <div class="email-detail-from">From: ${escapeHtml(from)}</div>
                            ${toRecipientsHTML}
                            ${ccRecipientsHTML}
                            <div class="email-detail-subject"><strong>Subject:</strong> ${escapeHtml(subject)}</div>
                            <div class="email-detail-date">${fullDate}</div>
                            <div class="email-detail-from" style="color:var(--text2);font-size:.75rem">Folder: ${escapeHtml(email.folder_name || email.folder || 'Unknown')}</div>
                            ${attachmentsHTML}
                        </div>

                        <!-- Collapsible Original Email Section -->
                        <div style="margin-top:12px;border-top:1px solid var(--border);padding-top:12px">
                            <button
                                class="response-btn"
                                onclick="toggleOriginalEmail('${email.id}')"
                                style="width:100%;text-align:left;display:flex;align-items:center;justify-content:space-between"
                            >
                                <span>üìß View Original Email</span>
                                <span id="email-toggle-icon-${email.id}">‚ñº</span>
                            </button>
                            <div id="original-email-${email.id}" style="display:none;margin-top:12px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px;max-height:400px;overflow-y:auto">
                                <div style="color:var(--text3);font-style:italic">Loading original email...</div>
                            </div>
                        </div>
                    </div>

                    <!-- Card 2: AI Analysis -->
                    <div class="ai-analysis-card">
                        <div class="email-card-title">AI ANALYSIS</div>

                        <div class="ai-section">
                            <div class="ai-section-label">Classification & Priority</div>
                            <div class="ai-section-content" id="topic-${email.id}">${aiSummary.topic}</div>
                        </div>

                        <div class="ai-section">
                            <div class="ai-section-label">Summary</div>
                            <div class="ai-section-content" id="summary-${email.id}">${aiSummary.summary}</div>
                        </div>

                        <div class="ai-section">
                            <div class="ai-section-label">Conversation Context</div>
                            <div class="ai-section-content" id="requesting-${email.id}">${aiSummary.request}</div>
                        </div>

                        <div class="ai-section">
                            <div class="ai-section-label">Action Items</div>
                            <div class="ai-section-content" id="actionItems-${email.id}">${aiSummary.actionItems}</div>
                        </div>

                        <div class="ai-section">
                            <div class="ai-section-label">Your Action</div>
                            <div class="ai-section-content" id="yourAction-${email.id}">${aiSummary.yourAction}</div>
                        </div>
                    </div>

                    <!-- Card 3: AI Recommended Action Plan -->
                    <div class="response-card" style="border:2px solid var(--purple)">
                        <div class="email-card-title">üéØ RECOMMENDED ACTION PLAN</div>

                        <div id="recommended-plan-${email.id}">
                            ${recommendedPlanHTML}
                        </div>

                        <div style="margin-top:10px;padding:10px;background:var(--bg2);border:1px solid var(--border);border-radius:6px">
                            <div style="font-size:.85rem;color:var(--text3);text-align:center">
                                üí¨ Use the ABBI chat panel below to discuss this email and give commands
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
                        <button class="response-btn" onclick="toggleEmail('${email.id}')" style="flex:1;min-width:200px">‚Üê Back to Email List</button>
                        <button class="response-btn primary" onclick="markEmailReadAndClose('${email.id}')" style="flex:1;min-width:200px">‚úì Mark as Read & Remove</button>
                    </div>
                </div>
            `;
        }

        // Generate AI Summary (enhanced - follows v6.2 protocol)
        function generateAISummary(email) {
            // Check if email has triaged data (from Hive Mind)
            const isTriaged = email.summary && email.priority && email.classification;

            if (isTriaged) {
                // Email is already triaged - display the data directly
                const priorityBadge = email.priority === 'HIGH'
                    ? '<span style="color:var(--red);font-weight:bold">‚ö†Ô∏è HIGH PRIORITY</span>'
                    : '<span style="color:var(--green)">NORMAL</span>';

                const classificationBadge = email.classification === 'To:'
                    ? '<span style="background:var(--purple);color:white;padding:2px 8px;border-radius:4px;font-size:.85rem">To:</span>'
                    : '<span style="background:var(--blue);color:white;padding:2px 8px;border-radius:4px;font-size:.85rem">CC:</span>';

                const tagBadge = email.tag === 'Needs Response'
                    ? '<span style="background:var(--red);color:white;padding:2px 8px;border-radius:4px;font-size:.85rem;margin-left:6px">‚ö° Needs Response</span>'
                    : '<span style="background:var(--text3);color:white;padding:2px 8px;border-radius:4px;font-size:.85rem;margin-left:6px">üìã FYI</span>';

                // Format action items as HTML list
                let actionItemsHTML = 'None';
                if (email.action_items && Array.isArray(email.action_items) && email.action_items.length > 0) {
                    actionItemsHTML = '<ul style="margin:4px 0;padding-left:20px">' +
                        email.action_items.map(item => `<li>${escapeHtml(item)}</li>`).join('') +
                        '</ul>';
                }

                // Format summary with line breaks preserved (convert \n to <br>)
                const formattedSummary = email.summary
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // Bold markdown
                    .replace(/\n/g, '<br>')  // Line breaks
                    .replace(/- /g, '‚Ä¢ ');  // Bullet points

                return {
                    topic: `${classificationBadge} ${tagBadge}<br><div style="margin-top:8px">${priorityBadge}</div>`,
                    summary: formattedSummary,
                    request: email.conversation_context || 'None',
                    actionItems: actionItemsHTML,
                    yourAction: email.tag === 'Needs Response'
                        ? '<span style="color:var(--red);font-weight:bold">‚ö° Response Required</span>'
                        : '<span style="color:var(--text3)">üìã No action needed - FYI only</span>'
                };
            } else {
                // Return loading placeholders - real AI analysis will replace these
                return {
                    topic: '‚è≥ Loading AI analysis...',
                    summary: 'Claude is analyzing this email. This will take 5-10 seconds...',
                    request: 'Processing...',
                    actionItems: 'Processing...',
                    yourAction: 'Processing...'
                };
            }
        }

        // Generate suggested response
        function generateSuggestedResponse(email) {
            const from = email.from_name || email.from || 'Unknown';
            const subject = email.subject || '';

            return {
                draft: `Hi ${from.split(' ')[0]},\n\nThank you for your email regarding ${subject}.\n\n[Your response here]\n\nBest regards,\nJohn Stewart`,
                forwardSuggestion: `Hi [Name],\n\nCould you please review this email and [provide your input/take necessary action/follow up]?\n\nThank you.`
            };
        }

        // Send email reply
        // Command Prompt Processor
        async function processCommand(emailId) {
            const commandInput = document.getElementById(`command-${emailId}`);
            const chatHistory = document.getElementById(`chat-history-${emailId}`);
            const email = liveData.emails.find(e => e.id === emailId);

            if (!email || !commandInput.value.trim()) {
                alert('Please enter a message');
                return;
            }

            const userMessage = commandInput.value.trim();
            const command = userMessage.toLowerCase();

            // Add user message to chat
            addChatMessage(emailId, 'user', userMessage);

            // Clear input
            commandInput.value = '';

            // Check if command is to execute the recommended plan
            if (command === 'execute' || command === 'approve' || command === 'send') {
                await executeRecommendedPlan(emailId);
                return;
            }

            // Detect if this is a question (conversational Q&A)
            const isQuestion = userMessage.includes('?') ||
                /^(who|what|when|where|why|how|can|could|would|should|is|are|do|does|did|has|have|will)/i.test(command);

            if (isQuestion) {
                await handleChatQuestion(emailId, userMessage);
                return;
            }

            // Otherwise, treat as a directive/clarification
            await handleChatDirective(emailId, userMessage);
        }

        // Store chat history for each email
        const emailChatHistories = {};

        function addChatMessage(emailId, role, message, isHtml = false) {
            const chatHistory = document.getElementById(`chat-history-${emailId}`);

            // Clear welcome message if this is the first message
            if (chatHistory.querySelector('[style*="italic"]')) {
                chatHistory.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `margin-bottom:8px;padding:8px;border-radius:6px;${
                role === 'user'
                    ? 'background:var(--purple);color:#fff;margin-left:40px;text-align:right'
                    : 'background:var(--bg2);border-left:3px solid var(--purple);margin-right:40px'
            }`;

            const header = document.createElement('div');
            header.style.cssText = 'font-size:.7rem;font-weight:700;margin-bottom:4px;opacity:.8';
            header.textContent = role === 'user' ? 'You' : 'ABBI';

            const content = document.createElement('div');
            content.style.cssText = 'font-size:.85rem;line-height:1.4;white-space:pre-wrap';
            if (isHtml) {
                content.innerHTML = message;
            } else {
                content.textContent = message;
            }

            messageDiv.appendChild(header);
            messageDiv.appendChild(content);
            chatHistory.appendChild(messageDiv);

            // Track in history (limit to last 10 messages for API efficiency)
            if (!emailChatHistories[emailId]) {
                emailChatHistories[emailId] = [];
            }
            emailChatHistories[emailId].push({ role, content: message });
            if (emailChatHistories[emailId].length > 10) {
                emailChatHistories[emailId].shift();
            }

            // Scroll to bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        async function handleChatQuestion(emailId, question) {
            const email = liveData.emails.find(e => e.id === emailId);
            if (!email) return;

            // Show "thinking" message
            addChatMessage(emailId, 'assistant', 'üí≠ Thinking...');

            try {
                // Get email context for ABBI
                const emailContext = email ? {
                    from: email.from,
                    to: email.to,
                    subject: email.subject,
                    received: email.received,
                    preview: email.preview,
                    body: email.body
                } : null;

                const response = await fetch('/api/email/chat-qa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: question,
                        email_context: emailContext,
                        conversation_history: emailChatHistories[emailId]?.slice(-6) || [] // Last 6 messages for context
                    })
                });

                const data = await response.json();

                // Remove "thinking" message
                const chatHistory = document.getElementById(`chat-history-${emailId}`);
                const lastMessage = chatHistory.lastElementChild;
                if (lastMessage && lastMessage.textContent.includes('Thinking')) {
                    chatHistory.removeChild(lastMessage);
                    // Remove from history tracker too
                    if (emailChatHistories[emailId]) {
                        emailChatHistories[emailId].pop();
                    }
                }

                if (data.success && data.answer) {
                    addChatMessage(emailId, 'assistant', data.answer);
                } else {
                    addChatMessage(emailId, 'assistant', `‚ùå Error: ${data.error || 'Failed to generate answer'}`);
                }

            } catch (error) {
                console.error('Chat Q&A error:', error);

                // Remove "thinking" message
                const chatHistory = document.getElementById(`chat-history-${emailId}`);
                const lastMessage = chatHistory.lastElementChild;
                if (lastMessage && lastMessage.textContent.includes('Thinking')) {
                    chatHistory.removeChild(lastMessage);
                    if (emailChatHistories[emailId]) {
                        emailChatHistories[emailId].pop();
                    }
                }

                addChatMessage(emailId, 'assistant', `‚ùå Error: ${error.message}`);
            }
        }

        async function handleChatDirective(emailId, directive) {
            const email = liveData.emails.find(e => e.id === emailId);
            if (!email) return;

            // Show "thinking" message
            addChatMessage(emailId, 'assistant', '‚ö° Processing your request...');

            try {
                const response = await fetch('/api/email/execute-directive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        directive: directive,
                        message_id: email.id,
                        user: 'jstewart@middleground.com',
                        email_context: {
                            from: email.from,
                            subject: email.subject,
                            body: email.body || email.preview,
                            analysis: email.analysis || {}
                        },
                        preview_only: false
                    })
                });

                const data = await response.json();

                // Remove "thinking" message
                const chatHistory = document.getElementById(`chat-history-${emailId}`);
                const lastMessage = chatHistory.lastElementChild;
                if (lastMessage && lastMessage.textContent.includes('Processing')) {
                    chatHistory.removeChild(lastMessage);
                }

                if (data.success && data.executed) {
                    let response = `‚úÖ Executed successfully!\n\n`;
                    response += `üìß Sent ${data.emails_sent} email(s)`;

                    if (data.sent_details && data.sent_details.length > 0) {
                        response += '\n\n';
                        data.sent_details.forEach(sent => {
                            response += `\n‚úì To: ${sent.to.join(', ')}\n  Subject: "${sent.subject}"`;
                        });
                    }

                    addChatMessage(emailId, 'assistant', response);

                    // Refresh dashboard
                    setTimeout(() => loadDashboardData(), 2000);

                } else {
                    addChatMessage(emailId, 'assistant', `‚ùå Error: ${data.error || 'Failed to execute directive'}`);
                }

            } catch (error) {
                console.error('Chat directive error:', error);

                // Remove "thinking" message
                const chatHistory = document.getElementById(`chat-history-${emailId}`);
                const lastMessage = chatHistory.lastElementChild;
                if (lastMessage && lastMessage.textContent.includes('Processing')) {
                    chatHistory.removeChild(lastMessage);
                }

                addChatMessage(emailId, 'assistant', `‚ùå Error: ${error.message}`);
            }
        }

        async function executeRecommendedPlan(emailId) {
            const email = liveData.emails.find(e => e.id === emailId);

            if (!email || !email.analysis || !email.analysis.recommendedPlan) {
                addChatMessage(emailId, 'assistant', '‚ùå No recommended plan available. Please re-process email with AI first.');
                return;
            }

            const plan = email.analysis.recommendedPlan;

            if (!plan.emails || plan.emails.length === 0) {
                addChatMessage(emailId, 'assistant', '‚ùå No emails to send in recommended plan');
                return;
            }

            // Check for missing contact info
            const needsContact = plan.emails.some(e => e.to.join(',').includes('NEED_CONTACT_INFO'));
            if (needsContact) {
                addChatMessage(emailId, 'assistant', '‚ö†Ô∏è Cannot execute: Contact information is needed. Please provide the missing contact details in your next message.');
                return;
            }

            if (!confirm(`This will send ${plan.emails.length} email(s) on your behalf:\n\n${plan.emails.map((e, i) => `${i+1}. To: ${e.to.join(', ')}\n   Subject: ${e.subject}`).join('\n\n')}\n\nAre you sure?`)) {
                addChatMessage(emailId, 'assistant', 'Execution cancelled.');
                return;
            }

            addChatMessage(emailId, 'assistant', `‚ö° Executing plan: sending ${plan.emails.length} email(s)...`);

            try {
                const sentEmails = [];
                const errors = [];

                // Send each email using M365 send_email (not reply)
                for (const emailDraft of plan.emails) {
                    try {
                        const response = await fetch(CONFIG.API_BASE + '/send-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                to: emailDraft.to,
                                cc: emailDraft.cc || [],
                                subject: emailDraft.subject,
                                body: emailDraft.body,
                                user: 'jstewart@middleground.com'
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            sentEmails.push({
                                to: emailDraft.to,
                                subject: emailDraft.subject
                            });
                        } else {
                            errors.push({
                                to: emailDraft.to,
                                error: result.error || 'Unknown error'
                            });
                        }

                    } catch (sendError) {
                        console.error('Failed to send email:', sendError);
                        errors.push({
                            to: emailDraft.to,
                            error: sendError.message
                        });
                    }
                }

                // Mark original email as read and categorize
                try {
                    await fetch(CONFIG.API_BASE + '/mark-read', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            message_ids: [email.id],
                            user: 'jstewart@middleground.com'
                        })
                    });
                } catch (e) {
                    console.error('Failed to mark as read:', e);
                }

                // Build success message
                let message = `‚úÖ Plan executed successfully!\n\nüìß Sent ${sentEmails.length} email(s)`;

                if (sentEmails.length > 0) {
                    message += '\n\n';
                    sentEmails.forEach(sent => {
                        message += `\n‚úì To: ${sent.to.join(', ')}\n  Subject: "${sent.subject}"`;
                    });
                }

                if (errors.length > 0) {
                    message += `\n\n‚ö†Ô∏è ${errors.length} email(s) failed to send:`;
                    errors.forEach(err => {
                        message += `\n‚ùå To: ${err.to.join(', ')}\n   Error: ${err.error}`;
                    });
                }

                addChatMessage(emailId, 'assistant', message);

                // Refresh dashboard after 2 seconds
                setTimeout(() => {
                    loadDashboardData();
                }, 2000);

            } catch (error) {
                console.error('Execute plan error:', error);
                addChatMessage(emailId, 'assistant', `‚ùå Error: ${error.message}`);
            }
        }

        async function executeCustomDirective(emailId, directive) {
            const email = liveData.emails.find(e => e.id === emailId);
            const resultArea = document.getElementById(`command-result-${emailId}`);

            if (!email) return;

            if (!confirm(`This will execute your directive: "${directive}"\n\nEmails will be drafted and sent on your behalf. Continue?`)) {
                return;
            }

            resultArea.style.display = 'block';
            resultArea.style.background = 'var(--bg2)';
            resultArea.style.border = '1px solid var(--border)';
            resultArea.innerHTML = '<div style="text-align:center;padding:20px">‚ö° Processing directive...</div>';

            try {
                const response = await fetch('/api/email/execute-directive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        directive: directive,
                        message_id: email.id,
                        user: 'jstewart@middleground.com',
                        email_context: {
                            from: email.from,
                            subject: email.subject,
                            body: email.body || email.preview,
                            analysis: email.analysis || {}
                        },
                        preview_only: false
                    })
                });

                const data = await response.json();

                if (data.success && data.executed) {
                    let html = '<div style="color:var(--green);font-weight:700;margin-bottom:12px">‚úÖ Directive Executed Successfully</div>';
                    html += `<div style="margin-bottom:8px">üìß ${data.emails_sent} email(s) sent</div>`;

                    if (data.sent_details && data.sent_details.length > 0) {
                        html += '<div style="margin-top:12px;font-size:.85rem">';
                        data.sent_details.forEach(sent => {
                            html += `<div style="padding:6px;background:var(--bg);border-radius:4px;margin-bottom:4px">`;
                            html += `‚úì Sent to: ${sent.to.join(', ')} - "${sent.subject}"`;
                            html += `</div>`;
                        });
                        html += '</div>';
                    }

                    if (data.errors && data.errors.length > 0) {
                        html += '<div style="margin-top:12px;color:var(--red)">';
                        html += `‚ö†Ô∏è ${data.errors.length} email(s) failed to send`;
                        html += '</div>';
                    }

                    resultArea.style.background = 'rgba(16, 185, 129, 0.1)';
                    resultArea.style.border = '1px solid var(--green)';
                    resultArea.innerHTML = html;

                    // Clear command input
                    document.getElementById(`command-${emailId}`).value = '';

                    // Refresh dashboard after 2 seconds
                    setTimeout(() => {
                        loadDashboardData();
                    }, 2000);

                } else {
                    resultArea.style.background = 'rgba(239, 68, 68, 0.1)';
                    resultArea.style.border = '1px solid var(--red)';
                    resultArea.innerHTML = '<div style="color:var(--red)">‚ùå ' + (data.error || 'Failed to execute directive') + '</div>';
                }

            } catch (error) {
                console.error('Execute directive error:', error);
                resultArea.style.background = 'rgba(239, 68, 68, 0.1)';
                resultArea.style.border = '1px solid var(--red)';
                resultArea.innerHTML = '<div style="color:var(--red)">‚ùå Error: ' + error.message + '</div>';
            }
        }

        // Legacy function kept for compatibility
        async function previewDirective(emailId) {
            const directiveInput = document.getElementById(`directive-${emailId}`);
            const previewArea = document.getElementById(`directive-preview-${emailId}`);
            const email = liveData.emails.find(e => e.id === emailId);

            if (!email || !directiveInput.value.trim()) {
                alert('Please enter a directive');
                return;
            }

            previewArea.style.display = 'block';
            previewArea.innerHTML = '<div style="text-align:center;padding:20px">‚è≥ Generating execution plan...</div>';

            try {
                const response = await fetch('/api/email/execute-directive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        directive: directiveInput.value.trim(),
                        message_id: email.id,
                        user: 'jstewart@middleground.com',
                        email_context: {
                            from: email.from,
                            subject: email.subject,
                            body: email.body || email.preview,
                            analysis: email.analysis || {}
                        },
                        preview_only: true
                    })
                });

                const data = await response.json();

                if (data.success && data.plan) {
                    const plan = data.plan;
                    let html = '<div style="font-weight:700;margin-bottom:12px;color:var(--purple)">üìã Execution Plan</div>';

                    // Show emails to be sent
                    if (plan.emails && plan.emails.length > 0) {
                        html += '<div style="margin-bottom:16px">';
                        html += '<div style="font-weight:600;margin-bottom:8px">üìß Emails to Send:</div>';

                        plan.emails.forEach((email, idx) => {
                            html += `<div style="background:var(--bg2);padding:12px;border-radius:6px;margin-bottom:8px;border-left:3px solid var(--purple)">`;
                            html += `<div style="font-weight:600;font-size:.9rem">#${idx + 1} ‚Üí ${email.to.join(', ')}</div>`;
                            if (email.cc && email.cc.length > 0) {
                                html += `<div style="font-size:.85rem;color:var(--text3);margin-top:4px">CC: ${email.cc.join(', ')}</div>`;
                            }
                            html += `<div style="font-weight:600;margin-top:8px">Subject: ${email.subject}</div>`;
                            html += `<div style="margin-top:8px;white-space:pre-wrap;font-size:.85rem;color:var(--text2)">${escapeHtml(email.body)}</div>`;
                            html += `<div style="margin-top:8px;font-size:.8rem;color:var(--text3);font-style:italic">${email.reasoning}</div>`;
                            html += `</div>`;
                        });
                        html += '</div>';
                    }

                    // Show tracking items
                    if (plan.tracking_items && plan.tracking_items.length > 0) {
                        html += '<div style="margin-bottom:16px">';
                        html += '<div style="font-weight:600;margin-bottom:8px">üìÖ Tracking Items:</div>';
                        plan.tracking_items.forEach(item => {
                            html += `<div style="background:var(--bg2);padding:8px;border-radius:6px;margin-bottom:6px;font-size:.85rem">`;
                            html += `${item.description} - Due: ${item.due_date}`;
                            html += `</div>`;
                        });
                        html += '</div>';
                    }

                    // Show follow-up actions
                    if (plan.follow_up_actions && plan.follow_up_actions.length > 0) {
                        html += '<div>';
                        html += '<div style="font-weight:600;margin-bottom:8px">‚úÖ Follow-up Actions:</div>';
                        plan.follow_up_actions.forEach(action => {
                            html += `<div style="background:var(--bg2);padding:8px;border-radius:6px;margin-bottom:6px;font-size:.85rem">`;
                            html += `‚Ä¢ ${action}`;
                            html += `</div>`;
                        });
                        html += '</div>';
                    }

                    previewArea.innerHTML = html;
                } else {
                    previewArea.innerHTML = '<div style="color:var(--red);padding:12px">‚ùå ' + (data.error || 'Failed to generate execution plan') + '</div>';
                }

            } catch (error) {
                console.error('Preview directive error:', error);
                previewArea.innerHTML = '<div style="color:var(--red);padding:12px">‚ùå Error: ' + error.message + '</div>';
            }
        }

        async function executeDirective(emailId) {
            const directiveInput = document.getElementById(`directive-${emailId}`);
            const resultArea = document.getElementById(`directive-result-${emailId}`);
            const email = liveData.emails.find(e => e.id === emailId);

            if (!email || !directiveInput.value.trim()) {
                alert('Please enter a directive');
                return;
            }

            if (!confirm('This will send emails on your behalf. Are you sure you want to execute this directive?')) {
                return;
            }

            resultArea.style.display = 'block';
            resultArea.style.background = 'var(--bg2)';
            resultArea.style.border = '1px solid var(--border)';
            resultArea.innerHTML = '<div style="text-align:center;padding:20px">‚ö° Executing directive...</div>';

            try {
                const response = await fetch('/api/email/execute-directive', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        directive: directiveInput.value.trim(),
                        message_id: email.id,
                        user: 'jstewart@middleground.com',
                        email_context: {
                            from: email.from,
                            subject: email.subject,
                            body: email.body || email.preview,
                            analysis: email.analysis || {}
                        },
                        preview_only: false
                    })
                });

                const data = await response.json();

                if (data.success && data.executed) {
                    let html = '<div style="color:var(--green);font-weight:700;margin-bottom:12px">‚úÖ Directive Executed Successfully</div>';
                    html += `<div style="margin-bottom:8px">üìß ${data.emails_sent} email(s) sent</div>`;

                    if (data.sent_details && data.sent_details.length > 0) {
                        html += '<div style="margin-top:12px;font-size:.85rem">';
                        data.sent_details.forEach(sent => {
                            html += `<div style="padding:6px;background:var(--bg);border-radius:4px;margin-bottom:4px">`;
                            html += `‚úì Sent to: ${sent.to.join(', ')} - "${sent.subject}"`;
                            html += `</div>`;
                        });
                        html += '</div>';
                    }

                    if (data.errors && data.errors.length > 0) {
                        html += '<div style="margin-top:12px;color:var(--red)">';
                        html += `‚ö†Ô∏è ${data.errors.length} email(s) failed to send`;
                        html += '</div>';
                    }

                    resultArea.style.background = 'rgba(16, 185, 129, 0.1)';
                    resultArea.style.border = '1px solid var(--green)';
                    resultArea.innerHTML = html;

                    // Clear the directive input
                    directiveInput.value = '';

                    // Refresh email list after 2 seconds
                    setTimeout(() => {
                        loadDashboardData();
                    }, 2000);

                } else {
                    resultArea.style.background = 'rgba(239, 68, 68, 0.1)';
                    resultArea.style.border = '1px solid var(--red)';
                    resultArea.innerHTML = '<div style="color:var(--red)">‚ùå ' + (data.error || 'Failed to execute directive') + '</div>';
                }

            } catch (error) {
                console.error('Execute directive error:', error);
                resultArea.style.background = 'rgba(239, 68, 68, 0.1)';
                resultArea.style.border = '1px solid var(--red)';
                resultArea.innerHTML = '<div style="color:var(--red)">‚ùå Error: ' + error.message + '</div>';
            }
        }

        async function sendEmailReply(emailId, replyAll) {
            const responseText = document.getElementById(`responseEditor-${emailId}`).value;
            const email = liveData.emails.find(e => e.id === emailId);
            const attachments = emailAttachments[emailId] || [];

            if (!email) return;

            if (!responseText.trim()) {
                alert('Please enter a response message.');
                return;
            }

            // Show loading state
            const replyBtn = event.target;
            const originalText = replyBtn.innerHTML;
            replyBtn.disabled = true;
            replyBtn.innerHTML = '<span style="opacity:0.6">Sending...</span>';

            try {
                // Convert attachments to base64
                const attachmentsData = [];
                for (const file of attachments) {
                    const base64 = await fileToBase64(file);
                    attachmentsData.push({
                        name: file.name,
                        type: file.type,
                        content: base64.split(',')[1] // Remove data:type;base64, prefix
                    });
                }

                // Send reply via backend API
                const response = await fetch('/api/email/send-reply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message_id: emailId,
                        user: 'john@middleground.com',
                        body: responseText,
                        reply_all: replyAll,
                        attachments: attachmentsData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`${replyAll ? 'Reply All' : 'Reply'} sent successfully!`);
                    // Clear attachments and response
                    emailAttachments[emailId] = [];
                    displayAttachments(emailId);
                    document.getElementById(`responseEditor-${emailId}`).value = '';
                } else {
                    alert(`Failed to send reply: ${result.error}`);
                }
            } catch (error) {
                console.error('Error sending reply:', error);
                alert(`Error sending reply: ${error.message}`);
            } finally {
                // Restore button
                replyBtn.disabled = false;
                replyBtn.innerHTML = originalText;
            }
        }

        // Helper: Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Forward email
        async function forwardEmail(emailId) {
            const forwardTo = document.getElementById(`forwardTo-${emailId}`).value;
            const forwardMessage = document.getElementById(`forwardMessage-${emailId}`).value;

            if (!forwardTo) {
                alert('Please enter an email address to forward to.');
                return;
            }

            // Show loading state
            const forwardBtn = event.target;
            const originalText = forwardBtn.innerHTML;
            forwardBtn.disabled = true;
            forwardBtn.innerHTML = '<span style="opacity:0.6">Forwarding...</span>';

            try {
                // Forward via backend API
                const response = await fetch('/api/email/forward', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message_id: emailId,
                        user: 'john@middleground.com',
                        to: forwardTo.split(',').map(e => e.trim()),
                        comment: forwardMessage
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`Email forwarded successfully to ${forwardTo}!`);
                    // Clear forward fields
                    document.getElementById(`forwardTo-${emailId}`).value = '';
                    document.getElementById(`forwardMessage-${emailId}`).value = '';
                } else {
                    alert(`Failed to forward email: ${result.error}`);
                }
            } catch (error) {
                console.error('Error forwarding email:', error);
                alert(`Error forwarding email: ${error.message}`);
            } finally {
                // Restore button
                forwardBtn.disabled = false;
                forwardBtn.innerHTML = originalText;
            }
        }

        // Store attachments per email
        const emailAttachments = {};

        // Handle file attachment
        function handleAttachment(emailId, input) {
            if (!input.files || input.files.length === 0) return;

            // Initialize attachment array for this email if needed
            if (!emailAttachments[emailId]) {
                emailAttachments[emailId] = [];
            }

            // Add new files to the list
            Array.from(input.files).forEach(file => {
                emailAttachments[emailId].push(file);
            });

            // Display attached files
            displayAttachments(emailId);

            // Clear the input so same file can be added again if removed
            input.value = '';
        }

        // Display attached files
        function displayAttachments(emailId) {
            const attachContainer = document.getElementById(`attachments-${emailId}`);
            if (!attachContainer) return;

            const files = emailAttachments[emailId] || [];

            if (files.length === 0) {
                attachContainer.innerHTML = '';
                return;
            }

            attachContainer.innerHTML = '<div style="margin-top:12px;padding:12px;background:var(--bg);border:1px solid var(--border);border-radius:6px">' +
                '<div style="font-weight:600;font-size:.8rem;margin-bottom:8px;color:var(--text)">üìé Attachments (' + files.length + ')</div>' +
                files.map((file, idx) => {
                    const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                    return '<div style="display:flex;align-items:center;gap:8px;padding:6px;background:var(--bg2);border-radius:4px;margin-bottom:4px">' +
                        '<span style="flex:1;font-size:.8rem;color:var(--text2)">' + escapeHtml(file.name) + ' (' + sizeMB + ' MB)</span>' +
                        '<button onclick="removeAttachment(\'' + emailId + '\', ' + idx + ')" style="padding:4px 8px;background:var(--red);border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:.7rem">Remove</button>' +
                    '</div>';
                }).join('') +
            '</div>';
        }

        // Remove attachment
        function removeAttachment(emailId, index) {
            if (emailAttachments[emailId]) {
                emailAttachments[emailId].splice(index, 1);
                displayAttachments(emailId);
            }
        }

        // Toggle meeting expand/collapse and show in center pane
        function toggleMeeting(meetingId) {
            if (expandedMeetingId === meetingId) {
                expandedMeetingId = null;
                renderContent(); // Go back to current view
            } else {
                expandedMeetingId = meetingId;
                renderMeetingDetails();
            }
        }

        // Render meeting details in center pane
        function renderMeetingDetails() {
            const container = document.getElementById('contentList');
            if (!liveData || !liveData.calendar) {
                container.innerHTML = '<div class="no-selection"><p>Meeting not found</p></div>';
                return;
            }

            const meeting = liveData.calendar.find(e => e.id === expandedMeetingId);
            if (!meeting) {
                container.innerHTML = '<div class="no-selection"><p>Meeting not found</p></div>';
                return;
            }

            // Format time
            const startTime = new Date(meeting.start);
            const endTime = new Date(meeting.end);
            const startEST = new Date(startTime.getTime() - (5 * 60 * 60 * 1000));
            const endEST = new Date(endTime.getTime() - (5 * 60 * 60 * 1000));

            const formatTime = (date) => {
                const hours = date.getHours();
                const minutes = date.getMinutes();
                const ampm = hours >= 12 ? 'PM' : 'AM';
                const displayHour = hours === 0 ? 12 : (hours > 12 ? hours - 12 : hours);
                return `${displayHour}:${minutes.toString().padStart(2, '0')} ${ampm}`;
            };

            const dateStr = startEST.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric',
                year: 'numeric',
                timeZone: 'America/New_York'
            });

            // Detect Zoom or Teams meeting links
            const location = meeting.location || '';
            const body = meeting.body || '';
            const zoomMatch = (location + ' ' + body).match(/(https:\/\/[^\s]*zoom\.us[^\s]*)/i);
            const teamsMatch = (location + ' ' + body).match(/(https:\/\/teams\.microsoft\.com[^\s]*)/i);

            let joinButton = '';
            if (zoomMatch) {
                joinButton = '<a href="' + zoomMatch[1] + '" target="_blank" class="email-action-btn primary">Join Zoom Meeting</a>';
            } else if (teamsMatch) {
                joinButton = '<a href="' + teamsMatch[1] + '" target="_blank" class="email-action-btn primary">Join Teams Meeting</a>';
            }

            document.getElementById('view-title').textContent = meeting.subject || 'Meeting Details';

            container.innerHTML =
                '<div style="padding:24px">' +
                    '<div style="display:flex;align-items:center;gap:16px;margin-bottom:24px;padding-bottom:16px;border-bottom:2px solid var(--border)">' +
                        '<div style="flex:1">' +
                            '<div style="font-size:1.5rem;font-weight:700;color:var(--text);margin-bottom:8px">' + escapeHtml(meeting.subject || 'No subject') + '</div>' +
                            '<div style="font-size:1rem;color:var(--text2);margin-bottom:4px">' + dateStr + '</div>' +
                            '<div style="font-size:1rem;color:var(--text2)">üïê ' + formatTime(startEST) + ' - ' + formatTime(endEST) + ' EST</div>' +
                        '</div>' +
                    '</div>' +
                    (meeting.location ? '<div style="background:var(--bg2);padding:16px;border-radius:8px;margin-bottom:16px"><div style="font-weight:600;color:var(--text);margin-bottom:8px">üìç Location</div><div style="color:var(--text2)"><a href="https://maps.google.com/maps?q=' + encodeURIComponent(meeting.location) + '" target="_blank" style="color:var(--purple);text-decoration:underline">' + escapeHtml(meeting.location) + '</a></div></div>' : '') +
                    (meeting.body ? '<div style="background:var(--bg2);padding:16px;border-radius:8px;margin-bottom:16px"><div style="font-weight:600;color:var(--text);margin-bottom:8px">üìù Description</div><div style="color:var(--text2);line-height:1.6;max-height:400px;overflow-y:auto">' + escapeHtml(meeting.body.substring(0, 1000)) + (meeting.body.length > 1000 ? '...' : '') + '</div></div>' : '') +
                    (meeting.hasAttachments ? '<div style="background:var(--bg2);padding:16px;border-radius:8px;margin-bottom:16px"><div style="font-weight:600;color:var(--text);margin-bottom:8px">üìé Attachments</div><div style="color:var(--text2)">This meeting has attachments. Click the paperclip button in the calendar to view them.</div></div>' : '') +
                    (meeting.attendees && meeting.attendees.length > 0 ? '<div style="background:var(--bg2);padding:16px;border-radius:8px;margin-bottom:16px"><div style="font-weight:600;color:var(--text);margin-bottom:8px">üë• Attendees (' + meeting.attendees.length + ')</div><div style="color:var(--text2)">' + meeting.attendees.map(a => {
                        // Handle multiple Microsoft Graph API attendee formats
                        let name = null;

                        // Format 1: a.emailAddress.name or a.emailAddress.address
                        if (a && typeof a === 'object' && a.emailAddress) {
                            name = a.emailAddress.name || a.emailAddress.address;
                        }
                        // Format 2: a.name or a.email
                        else if (a && typeof a === 'object') {
                            name = a.name || a.email || a.displayName || a.address;
                        }
                        // Format 3: plain string
                        else if (typeof a === 'string') {
                            name = a;
                        }

                        return escapeHtml(name || 'Attendee');
                    }).join(', ') + '</div></div>' : '') +
                    '<div style="display:flex;gap:12px;flex-wrap:wrap">' +
                        joinButton +
                        '<button class="email-action-btn" onclick="toggleMeeting(\'' + meeting.id + '\')">Close</button>' +
                    '</div>' +
                '</div>';
        }

        // Generate and display daily briefing
        async function generateDailyBriefing() {
            console.log(`üöÄ generateDailyBriefing() called (ALL FOLDERS)`);

            // Clear preload cache when returning to briefing view
            window.emailPreloadCache = {};

            // Set view to daily-briefing mode to prevent renderContent() from overwriting
            currentView = 'daily-briefing';
            document.getElementById('view-title').textContent = 'Daily Briefing';

            const container = document.getElementById('contentList');

            let msgInterval; // Declare outside try so catch can access

            try {

                container.innerHTML = '<div class="no-selection"><p style="font-size:1.2rem">Generating daily briefing<span id="loading-dots" style="display:inline-block;width:1.5em;text-align:left">.</span></p><p style="font-size:.8rem;color:var(--text2);margin-top:8px">Reviewing all folders, surfacing important emails</p></div>';
                console.log('üìù Set loading message in container');

                // Also animate the dots in the message
                const msgDotCount = { count: 1 };
                msgInterval = setInterval(() => {
                    const dotsEl = document.getElementById('loading-dots');
                    if (dotsEl) {
                        dotsEl.textContent = '.'.repeat(msgDotCount.count);
                        msgDotCount.count = (msgDotCount.count % 3) + 1;
                    }
                }, 500);

                console.log(`üåê Fetching triaged emails from Hive Mind...`);

                // Add 30s timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const res = await fetch(`/api/email/triaged-emails`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                clearInterval(msgInterval);

                console.log('üì° API response status:', res.status);

                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }

                const data = await res.json();
                console.log('üìä API data received:', {
                    total_emails_reviewed: data.total_emails_reviewed,
                    emails_requiring_attention: data.emails_requiring_attention,
                    emails_count: data.emails?.length || 0,
                    cached: data.cached,
                    cache_age_minutes: data.cache_age_minutes
                });
                console.log('üìß First 3 emails:', data.emails?.slice(0, 3));

                let titleText = `Daily Briefing (${data.emails_requiring_attention} emails)`;
                if (data.cached) {
                    titleText += ` ‚Ä¢ Cached ${data.cache_age_minutes}m ago`;
                }
                document.getElementById('view-title').textContent = titleText;

                if (data.emails.length === 0) {
                    console.log('‚ö†Ô∏è No emails to display');
                    let emptyHtml = '<div style="padding:20px">';
                    emptyHtml += '<div style="background:var(--bg2);padding:16px;border-radius:12px;margin-bottom:20px;border-left:4px solid var(--purple)">';
                    emptyHtml += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
                    emptyHtml += '<div style="font-weight:700">Daily Executive Email Briefing</div>';
                    emptyHtml += '<button onclick="refreshDailyBriefing()" style="background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:6px 12px;cursor:pointer;font-size:.85rem;font-weight:600">üîÑ Refresh</button>';
                    emptyHtml += '</div>';
                    let emptyStatusText = 'Reviewed ' + data.total_emails_reviewed + ' emails in ' + data.processing_time;
                    if (data.cached) {
                        emptyStatusText += ' ‚Ä¢ Loaded from cache (' + data.cache_age_minutes + 'm old)';
                    }
                    emptyHtml += '<div style="font-size:.8rem;color:var(--text2)">' + emptyStatusText + '</div>';
                    emptyHtml += '</div>';
                    emptyHtml += '<div class="no-selection"><p>‚úÖ All caught up!</p><p style="font-size:.8rem;color:var(--text2);margin-top:8px">No emails require attention</p></div>';
                    emptyHtml += '</div>';
                    container.innerHTML = emptyHtml;
                    return;
                }

                console.log('‚úÖ Data valid, proceeding to build HTML...');

                // Group emails by category
                const emailsByCategory = {
                    'Urgent/Priority': [],
                    'To: Need Response/Action': [],
                    'To: FYI': [],
                    'CC: Need Response/Action': [],
                    'CC: FYI': []
                };

                data.emails.forEach(email => {
                    if (emailsByCategory[email.category]) {
                        emailsByCategory[email.category].push(email);
                    } else {
                        console.warn('‚ö†Ô∏è Email has unknown category:', email.category);
                    }
                });

                console.log('üìÇ Emails grouped by category:', {
                    'Urgent/Priority': emailsByCategory['Urgent/Priority'].length,
                    'To: Need Response/Action': emailsByCategory['To: Need Response/Action'].length,
                    'To: FYI': emailsByCategory['To: FYI'].length,
                    'CC: Need Response/Action': emailsByCategory['CC: Need Response/Action'].length,
                    'CC: FYI': emailsByCategory['CC: FYI'].length
                });

                // Display categories
                let html = '<div style="padding:20px">';
                html += '<div style="background:var(--bg2);padding:16px;border-radius:12px;margin-bottom:20px;border-left:4px solid var(--purple)">';
                html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">';
                html += '<div style="font-weight:700">Daily Executive Email Briefing</div>';
                html += '<button onclick="refreshDailyBriefing()" style="background:var(--bg);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:6px 12px;cursor:pointer;font-size:.85rem;font-weight:600">üîÑ Refresh</button>';
                html += '</div>';
                let statusText = 'Reviewed ' + data.total_emails_reviewed + ' emails in ' + data.processing_time;
                if (data.cached) {
                    statusText += ' ‚Ä¢ Loaded from cache (' + data.cache_age_minutes + 'm old)';
                }
                html += '<div style="font-size:.8rem;color:var(--text2)">' + statusText + '</div>';
                html += '</div>';

                // Display each category with emails
                for (const [category, emails] of Object.entries(emailsByCategory)) {
                    if (emails.length === 0) continue;

                    const categoryColors = {
                        'Urgent/Priority': 'var(--red)',
                        'To: Need Response/Action': 'var(--amber)',
                        'To: FYI': 'var(--green)',
                        'CC: Need Response/Action': 'var(--blue)',
                        'CC: FYI': 'var(--text2)'
                    };

                    console.log(`üìß Building HTML for category: ${category} (${emails.length} emails)`);

                    html += '<div style="margin-bottom:24px">';
                    html += '<div style="font-weight:700;font-size:1.1rem;color:' + categoryColors[category] + ';margin-bottom:12px;display:flex;align-items:center;gap:8px">';
                    html += '<span>‚óè</span> ' + category + ' (' + emails.length + ')';
                    html += '</div>';

                    emails.forEach((email, idx) => {
                        // Check if high-priority (will be flagged when viewed)
                        const isHighPriority = email.category === 'Urgent/Priority' ||
                                               email.priority === 'urgent' ||
                                               email.priority === 'high';
                        const flagIndicator = isHighPriority ? '<span style="color:var(--red);margin-left:8px" title="High priority - flagged for follow-up">üö©</span>' : '';

                        html += '<div onclick="processEmail(\'' + email.id + '\')" style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background=\'var(--bg2)\'" onmouseout="this.style.background=\'var(--card)\'">';
                        html += '<div style="font-weight:600;margin-bottom:4px">' + escapeHtml(email.subject || 'No subject') + flagIndicator + '</div>';
                        html += '<div style="font-size:.8rem;color:var(--text2)">From: ' + escapeHtml(email.from) + ' ‚Ä¢ ' + (email.folder || 'Inbox') + '</div>';
                        html += '</div>';
                    });

                    html += '</div>';
                }

                html += '</div>';
                console.log('üìù HTML built, length:', html.length);
                console.log('üìù Setting container.innerHTML...');
                container.innerHTML = html;
                console.log('‚úÖ container.innerHTML set successfully');
                console.log('üîç Container content check:', container.innerHTML.substring(0, 100));

                // Store all emails for reference
                window.allBriefingEmails = data.emails;

                // UPDATE SIDEBAR COUNTS with briefing results
                console.log('üìä Updating sidebar category counts...');
                document.getElementById('email-urgent-priority').textContent = emailsByCategory['Urgent/Priority'].length;
                document.getElementById('email-to-need-response').textContent = emailsByCategory['To: Need Response/Action'].length;
                document.getElementById('email-to-fyi').textContent = emailsByCategory['To: FYI'].length;
                document.getElementById('email-cc-need-response').textContent = emailsByCategory['CC: Need Response/Action'].length;
                document.getElementById('email-cc-fyi').textContent = emailsByCategory['CC: FYI'].length;
                document.getElementById('email-unprocessed').textContent = 0; // All processed
                console.log('‚úÖ Sidebar counts updated');

                // Watch for any changes to container for next 10 seconds
                const originalHTML = container.innerHTML;
                let checkCount = 0;
                const watcher = setInterval(() => {
                    checkCount++;
                    if (container.innerHTML !== originalHTML) {
                        console.error('üö® CONTAINER CHANGED! Check #' + checkCount);
                        console.error('üö® New content:', container.innerHTML.substring(0, 200));
                        console.trace('üö® Stack trace of where we are:');
                        clearInterval(watcher);
                    }
                    if (checkCount >= 20) {
                        console.log('‚úÖ Container stable for 10 seconds, watcher stopping');
                        clearInterval(watcher);
                    }
                }, 500);

                // Note: To see updated category counts in left sidebar, click on any category view
                // This will trigger a fresh data fetch without interfering with the briefing display

                // Function to filter briefing by category (when clicking sidebar)
                window.filterBriefingByCategory = function(categoryName) {
                    console.log('üîç Filtering briefing by category:', categoryName);

                    const filteredEmails = window.allBriefingEmails.filter(e => e.category === categoryName);
                    console.log(`Found ${filteredEmails.length} emails in category ${categoryName}`);

                    const categoryColors = {
                        'Urgent/Priority': 'var(--red)',
                        'To: Need Response/Action': 'var(--amber)',
                        'To: FYI': 'var(--green)',
                        'CC: Need Response/Action': 'var(--blue)',
                        'CC: FYI': 'var(--text2)'
                    };

                    let html = '<div style="padding:20px">';
                    html += '<div style="background:var(--bg2);padding:16px;border-radius:12px;margin-bottom:20px;border-left:4px solid var(--purple)">';
                    html += '<div style="font-weight:700;margin-bottom:8px">Daily Executive Email Briefing</div>';
                    html += '<button onclick="generateDailyBriefing()" style="padding:6px 12px;background:var(--purple);color:white;border:none;border-radius:6px;cursor:pointer;font-size:.85rem">‚Üê Back to All Categories</button>';
                    html += '</div>';

                    html += '<div style="margin-bottom:24px">';
                    html += '<div style="font-weight:700;font-size:1.1rem;color:' + categoryColors[categoryName] + ';margin-bottom:12px;display:flex;align-items:center;gap:8px">';
                    html += '<span>‚óè</span> ' + categoryName + ' (' + filteredEmails.length + ')';
                    html += '</div>';

                    filteredEmails.forEach((email, idx) => {
                        // Check if high-priority (will be flagged when viewed)
                        const isHighPriority = email.category === 'Urgent/Priority' ||
                                               email.priority === 'urgent' ||
                                               email.priority === 'high';
                        const flagIndicator = isHighPriority ? '<span style="color:var(--red);margin-left:8px" title="High priority - flagged for follow-up">üö©</span>' : '';

                        html += '<div onclick="processEmail(\'' + email.id + '\')" style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background=\'var(--bg2)\'" onmouseout="this.style.background=\'var(--card)\'">';
                        html += '<div style="font-weight:600;margin-bottom:4px">' + escapeHtml(email.subject || 'No subject') + flagIndicator + '</div>';
                        html += '<div style="font-size:.8rem;color:var(--text2)">From: ' + escapeHtml(email.from) + ' ‚Ä¢ ' + (email.folder || 'Inbox') + '</div>';
                        html += '</div>';
                    });

                    html += '</div>';
                    html += '</div>';

                    container.innerHTML = html;
                };

                // Preload cache for instant email navigation
                window.emailPreloadCache = {};

                // Preload next email in background
                async function preloadNextEmail(emailId) {
                    // Don't preload if already cached
                    if (window.emailPreloadCache[emailId]) {
                        console.log('üì¶ Email already cached:', emailId);
                        return;
                    }

                    const email = window.allBriefingEmails.find(e => e.id === emailId);
                    if (!email) return;

                    const mailbox = email.mailbox || 'jstewart@middleground.com';
                    console.log('‚è© Preloading next email:', emailId);

                    try {
                        const res = await fetch('/api/email/process-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email_id: emailId,
                                user: mailbox
                            })
                        });

                        if (res.ok) {
                            const analysis = await res.json();
                            window.emailPreloadCache[emailId] = analysis;
                            console.log('‚úÖ Preloaded email:', emailId);
                        }
                    } catch (error) {
                        console.warn('Failed to preload email:', error.message);
                    }
                }

                // Function to process individual email (Stage 2: Detailed processing)
                window.processEmail = async function(emailId) {
                    // Find the email
                    const email = window.allBriefingEmails.find(e => e.id === emailId);
                    if (!email) {
                        console.error('Email not found in allBriefingEmails:', emailId);
                        return;
                    }

                    const priorityColors = {
                        urgent: 'var(--red)',
                        high: 'var(--amber)',
                        medium: 'var(--green)',
                        fyi: 'var(--text2)'
                    };
                    const priorityColor = priorityColors[email.priority] || 'var(--text2)';

                    // Check cache first for instant display
                    let analysis = window.emailPreloadCache[emailId];

                    if (analysis) {
                        console.log('‚ö° Using cached email:', emailId);
                        // Don't show loading - go straight to display
                    } else {
                        // Show loading state only if not cached
                        container.innerHTML = '<div style="padding:20px">' +
                            '<div style="background:var(--bg2);padding:16px;border-radius:12px;margin-bottom:20px;border-left:4px solid var(--purple)">' +
                                '<div style="font-weight:700;margin-bottom:8px">Daily Executive Email Briefing</div>' +
                                '<div style="font-size:.8rem;color:var(--purple)">Processing detailed analysis<span id="processing-dots" style="display:inline-block;width:1.5em;text-align:left">.</span></div>' +
                            '</div>' +
                            '<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px">' +
                                '<div style="font-weight:600;margin-bottom:8px">' + escapeHtml(email.subject || 'No subject') + '</div>' +
                                '<div style="font-size:.8rem;color:var(--text2)">From: ' + escapeHtml(email.from) + '</div>' +
                            '</div>' +
                        '</div>';

                        // Animate dots while processing
                        let processingDotCount = 1;
                        const processingInterval = setInterval(() => {
                            const dotsEl = document.getElementById('processing-dots');
                            if (dotsEl) {
                                dotsEl.textContent = '.'.repeat(processingDotCount);
                                processingDotCount = (processingDotCount % 3) + 1;
                            } else {
                                clearInterval(processingInterval);
                            }
                        }, 500);
                    }

                    try {
                        // Fetch if not in cache
                        if (!analysis) {
                            const mailbox = email.mailbox || 'jstewart@middleground.com';
                            console.log('Processing email:', emailId, 'for mailbox:', mailbox);
                            const res = await fetch('/api/email/process-email', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    email_id: emailId,
                                    user: mailbox
                                })
                            });

                            if (!res.ok) {
                                throw new Error(`HTTP ${res.status}`);
                            }

                            analysis = await res.json();
                            // Cache it for back navigation
                            window.emailPreloadCache[emailId] = analysis;
                        }

                        // Find current email position for navigation
                        const currentIndex = window.allBriefingEmails.findIndex(e => e.id === emailId);
                        const hasPrev = currentIndex > 0;
                        const hasNext = currentIndex < window.allBriefingEmails.length - 1;

                        // Display detailed results
                        let html = '<div style="padding:20px">';
                        html += '<div style="background:var(--bg2);padding:16px;border-radius:12px;margin-bottom:20px;border-left:4px solid var(--purple)">';
                        html += '<div style="display:flex;justify-content:space-between;align-items:center">';
                        html += '<div>';
                        html += '<div style="font-weight:700;margin-bottom:4px">Daily Executive Email Briefing</div>';
                        html += '<div style="font-size:.75rem;color:var(--text2)">Email ' + (currentIndex + 1) + ' of ' + window.allBriefingEmails.length + '</div>';
                        html += '</div>';
                        html += '<div style="display:flex;gap:8px">';
                        html += '<button onclick="generateDailyBriefing()" style="padding:6px 12px;background:var(--purple);color:white;border:none;border-radius:6px;cursor:pointer;font-size:.85rem">‚Üê Back to All</button>';
                        if (hasPrev) {
                            html += '<button onclick="processEmail(\'' + window.allBriefingEmails[currentIndex - 1].id + '\')" style="padding:6px 12px;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:.85rem">‚Üê Previous</button>';
                        }
                        if (hasNext) {
                            html += '<button onclick="processEmail(\'' + window.allBriefingEmails[currentIndex + 1].id + '\')" style="padding:6px 12px;background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:.85rem">Next ‚Üí</button>';
                        }
                        html += '</div>';
                        html += '</div>';
                        html += '</div>';

                        html += '<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;border-left:4px solid ' + priorityColor + '">';
                        html += '<div style="font-size:.7rem;color:' + priorityColor + ';font-weight:700;text-transform:uppercase;margin-bottom:4px">‚óè ' + email.priority + ' PRIORITY ‚Ä¢ ' + email.category + '</div>';
                        html += '<div style="font-weight:600;font-size:1.1rem;margin-bottom:8px">' + escapeHtml(email.subject || 'No subject') + '</div>';

                        // Email metadata (From, To, CC, Date)
                        html += '<div style="background:var(--bg);padding:12px;border-radius:8px;margin-bottom:16px;font-size:.8rem;line-height:1.6">';

                        // Extract From (handle object or string)
                        let fromDisplay = 'Unknown';
                        if (analysis.from) {
                            if (typeof analysis.from === 'string') {
                                fromDisplay = analysis.from;
                            } else if (analysis.from.emailAddress) {
                                fromDisplay = analysis.from.emailAddress.name || analysis.from.emailAddress.address;
                            }
                        } else if (email.from) {
                            fromDisplay = email.from;
                        }
                        html += '<div style="margin-bottom:4px"><span style="color:var(--text3);font-weight:600">From:</span> <span style="color:var(--text2)">' + escapeHtml(fromDisplay) + '</span></div>';

                        // Extract To (handle array of objects or strings)
                        if (analysis.to && analysis.to.length > 0) {
                            const toList = Array.isArray(analysis.to)
                                ? analysis.to.map(r => {
                                    if (typeof r === 'string') return r;
                                    if (r.emailAddress) return r.emailAddress.name || r.emailAddress.address;
                                    return 'Unknown';
                                  }).join(', ')
                                : (typeof analysis.to === 'string' ? analysis.to : analysis.to.emailAddress?.name || analysis.to.emailAddress?.address || 'Unknown');
                            html += '<div style="margin-bottom:4px"><span style="color:var(--text3);font-weight:600">To:</span> <span style="color:var(--text2)">' + escapeHtml(toList) + '</span></div>';
                        }

                        // Extract CC (handle array of objects or strings)
                        if (analysis.cc && analysis.cc.length > 0) {
                            const ccList = Array.isArray(analysis.cc)
                                ? analysis.cc.map(r => {
                                    if (typeof r === 'string') return r;
                                    if (r.emailAddress) return r.emailAddress.name || r.emailAddress.address;
                                    return 'Unknown';
                                  }).join(', ')
                                : (typeof analysis.cc === 'string' ? analysis.cc : analysis.cc.emailAddress?.name || analysis.cc.emailAddress?.address || 'Unknown');
                            html += '<div style="margin-bottom:4px"><span style="color:var(--text3);font-weight:600">CC:</span> <span style="color:var(--text2)">' + escapeHtml(ccList) + '</span></div>';
                        }

                        if (analysis.received || email.received) {
                            const dateStr = new Date(analysis.received || email.received).toLocaleString('en-US', {
                                weekday: 'short',
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric',
                                hour: 'numeric',
                                minute: '2-digit'
                            });
                            html += '<div><span style="color:var(--text3);font-weight:600">Date:</span> <span style="color:var(--text2)">' + dateStr + '</span></div>';
                        }
                        html += '</div>';

                        // Comprehensive Executive Summary
                        if (analysis.comprehensive_summary) {
                            html += '<div style="background:var(--bg);padding:20px;border-radius:8px;line-height:1.8;font-size:.95rem;color:var(--text);white-space:pre-wrap;margin-bottom:16px">';
                            html += escapeHtml(analysis.comprehensive_summary);
                            html += '</div>';
                        }

                        // Full email body
                        if (analysis.body) {
                            html += '<div style="margin-bottom:12px">';
                            html += '<button onclick="document.getElementById(\'email-body-content\').style.display = document.getElementById(\'email-body-content\').style.display === \'none\' ? \'block\' : \'none\'; this.textContent = document.getElementById(\'email-body-content\').style.display === \'none\' ? \'‚ñº Show Full Email\' : \'‚ñ≤ Hide Full Email\'" style="padding:8px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:.85rem;color:var(--text);width:100%;text-align:left">‚ñº Show Full Email</button>';
                            html += '<div id="email-body-content" style="display:none;background:var(--bg);padding:16px;border-radius:8px;margin-top:8px;max-height:600px;overflow-y:auto">';
                            html += '<div style="color:var(--text) !important;line-height:1.6;font-size:.85rem">' + analysis.body + '</div>';
                            html += '</div>';
                            html += '</div>';
                        }

                        // Action buttons
                        html += '<div style="display:flex;gap:8px;margin-top:16px;flex-wrap:wrap">';
                        html += '<button class="response-btn" onclick="currentView=\'email-unprocessed\';renderContent()" style="flex:1;min-width:200px">‚Üê Back to Email List</button>';
                        html += '<button class="response-btn primary" onclick="markEmailReadAndClose(\'' + emailId + '\')" style="flex:1;min-width:200px">‚úì Mark as Read & Close</button>';
                        html += '</div>';

                        html += '</div>';
                        html += '</div>';

                        container.innerHTML = html;

                        // Store email context for existing chat interface at bottom of page
                        window.currentEmailContext = analysis;

                        // Auto-mark email as read (skip for high-priority categories)
                        const mailbox = email.mailbox || 'jstewart@middleground.com';
                        const emailCategory = analysis.category || email.category || 'unknown';
                        autoMarkEmailRead(emailId, emailCategory, mailbox);

                        // Auto-generate suggested actions in chat panel
                        autoSuggestActions(email, analysis);

                        // Preload next and previous emails in background for instant navigation
                        if (hasNext) {
                            const nextEmailId = window.allBriefingEmails[currentIndex + 1].id;
                            preloadNextEmail(nextEmailId);
                        }
                        if (hasPrev) {
                            const prevEmailId = window.allBriefingEmails[currentIndex - 1].id;
                            preloadNextEmail(prevEmailId); // Uses same function, just preloads it
                        }

                    } catch (error) {
                        console.error('Error processing email:', error);
                        container.innerHTML = '<div style="padding:20px">' +
                            '<div style="background:var(--bg2);padding:16px;border-radius:12px;margin-bottom:20px;border-left:4px solid var(--red)">' +
                                '<div style="font-weight:700;margin-bottom:8px;color:var(--red)">‚ùå Error Processing Email</div>' +
                                '<div style="font-size:.8rem;color:var(--text2)">' + error.message + '</div>' +
                                '<button onclick="generateDailyBriefing()" style="padding:6px 12px;background:var(--purple);color:white;border:none;border-radius:6px;cursor:pointer;font-size:.85rem;margin-top:8px">‚Üê Back to Briefing</button>' +
                            '</div>' +
                        '</div>';
                    }
                }

                // Function to load email body on demand
                window.loadEmailBody = async function(emailId, index) {
                    const contentDiv = document.getElementById('email-body-content-' + index);
                    const textDiv = document.getElementById('email-body-text-' + index);
                    const btn = document.getElementById('email-body-btn-' + index);

                    if (contentDiv.style.display === 'none') {
                        // Show and load
                        contentDiv.style.display = 'block';
                        btn.textContent = '‚ñ≤ Hide Full Email';

                        try {
                            const res = await fetch('https://m365-mcp-west.nicecliff-a1c1a3b6.westus2.azurecontainerapps.io/mcp', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    jsonrpc: '2.0',
                                    method: 'tools/call',
                                    params: {
                                        name: 'get_email',
                                        arguments: {
                                            message_id: emailId,
                                            user: 'jstewart@middleground.com'
                                        }
                                    },
                                    id: Date.now()
                                })
                            });

                            const data = await res.json();
                            const body = data.result?.content?.[0]?.text;
                            const parsed = JSON.parse(body);
                            textDiv.textContent = parsed.body?.content || parsed.bodyPreview || 'No body available';
                        } catch (error) {
                            textDiv.textContent = 'Error loading email body: ' + error.message;
                        }
                    } else {
                        // Hide
                        contentDiv.style.display = 'none';
                        btn.textContent = '‚ñº Show Full Email';
                    }
                };

            } catch (error) {
                // Clear loading animations
                if (msgInterval) clearInterval(msgInterval);

                console.error('Briefing generation failed:', error);
                container.innerHTML = '<div class="no-selection"><p>‚ùå Failed to generate briefing</p><p style="font-size:.8rem;color:var(--text2);margin-top:8px">' + escapeHtml(error.message) + '</p><p style="font-size:.7rem;color:var(--text3);margin-top:12px">Check console for details. Try refreshing the page.</p></div>';
            }
        }

        // Render content based on current view
        function renderContent() {
            console.log('üìç renderContent() called with currentView:', currentView);
            const container = document.getElementById('contentList');

            // v8.88: Auto-trigger daily briefing on load
            if (currentView === 'daily-briefing') {
                console.log('üöÄ Auto-loading Daily Briefing from cache');
                generateDailyBriefing();
                return;
            }

            // Show welcome screen prompting to run Daily Briefing
            if (currentView === 'welcome') {
                document.getElementById('view-title').textContent = 'Executive Dashboard';
                container.innerHTML = `
                    <div style="display:flex;align-items:center;justify-content:center;height:100%;padding:40px">
                        <div style="text-align:center;max-width:600px">
                            <div style="font-size:3rem;margin-bottom:20px">üìß</div>
                            <h2 style="color:var(--text);margin-bottom:16px;font-size:1.5rem">Email Triage Dashboard</h2>
                            <p style="color:var(--text2);margin-bottom:32px;line-height:1.6">
                                Click <strong>Daily Briefing</strong> to process emails from today and yesterday across all 32 priority folders.
                                The AI will categorize them and provide executive summaries with recommended actions.
                            </p>
                            <button onclick="generateDailyBriefing()" style="padding:12px 24px;background:var(--purple);color:white;border:none;border-radius:8px;cursor:pointer;font-size:1rem;font-weight:600">
                                Run Daily Briefing
                            </button>
                            <p style="color:var(--text3);margin-top:24px;font-size:.85rem">
                                Or use the sidebar to view categorized emails from previous briefings
                            </p>
                        </div>
                    </div>
                `;
                return;
            }

            if (currentView.startsWith('tasks-')) {
                renderTaskList(container);
            } else if (currentView.startsWith('email-')) {
                renderEmailList(container);
            }
        }

        function renderEmailList(container) {
            // Filter emails based on current view
            let filteredEmails = liveData.emails || [];

            if (currentView === 'email-unprocessed') {
                // Show emails WITHOUT "Processed" tag
                filteredEmails = filteredEmails.filter(e => !e.categories || !e.categories.includes('Processed'));
            } else if (currentView === 'email-urgent-priority') {
                filteredEmails = filteredEmails.filter(e => e.categories?.includes('Processed') && e.categories?.includes('Urgent/Priority'));
            } else if (currentView === 'email-to-need-response') {
                filteredEmails = filteredEmails.filter(e => e.categories?.includes('Processed') && e.categories?.includes('To: Need Response/Action'));
            } else if (currentView === 'email-to-fyi') {
                filteredEmails = filteredEmails.filter(e => e.categories?.includes('Processed') && e.categories?.includes('To: FYI'));
            } else if (currentView === 'email-cc-need-response') {
                filteredEmails = filteredEmails.filter(e => e.categories?.includes('Processed') && e.categories?.includes('CC: Need Response/Action'));
            } else if (currentView === 'email-cc-fyi') {
                filteredEmails = filteredEmails.filter(e => e.categories?.includes('Processed') && e.categories?.includes('CC: FYI'));
            }

            // Update title with count
            const titles = {
                'email-unprocessed': 'UNPROCESSED',
                'email-urgent-priority': 'Urgent/Priority',
                'email-to-need-response': 'To: Need Response/Action',
                'email-to-fyi': 'To: FYI',
                'email-cc-need-response': 'CC: Need Response/Action',
                'email-cc-fyi': 'CC: FYI'
            };
            const viewTitle = titles[currentView] || 'Emails';
            document.getElementById('view-title').textContent = `${viewTitle} (${filteredEmails.length})`;

            if (filteredEmails.length === 0) {
                container.innerHTML = '<div class="no-selection"><p>No emails found</p></div>';
                return;
            }

            // Render as simple list - clicking an item will show 3-column view
            container.innerHTML = filteredEmails.map((email, idx) => {
                const id = email.id || idx;
                const from = email.from_name || email.from || 'Unknown';
                const subject = email.subject || '(No subject)';
                const preview = email.preview || email.bodyPreview || '';
                const time = formatEmailTime(email.date || email.receivedDateTime);
                const priority = email.importance === 'high' ? 'high' : 'medium';

                return '<div class="email-item" onclick="toggleEmail(\'' + id + '\')">' +
                    '<div class="email-header">' +
                        '<div class="email-priority ' + priority + '"></div>' +
                        '<div class="email-content">' +
                            '<div class="email-from">' + escapeHtml(from) + '</div>' +
                            '<div class="email-subject">' + escapeHtml(subject) + '</div>' +
                            '<div class="email-preview">' + escapeHtml(preview) + '</div>' +
                        '</div>' +
                        '<div class="email-meta">' +
                            '<span class="email-time">' + time + '</span>' +
                        '</div>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function renderTaskList(container) {
            const now = new Date();
            const todayEST = now.toLocaleDateString('en-US', { timeZone: 'America/New_York' });

            // Filter tasks based on current view
            let filteredTasks = liveData.tasks || [];

            if (currentView === 'tasks-received') {
                // Show all tasks (received today)
                filteredTasks = filteredTasks;
            } else if (currentView === 'tasks-due') {
                // Show tasks due today
                filteredTasks = filteredTasks.filter(t => {
                    if (!t.due_on && !t.due_date) return false;
                    const dueDate = new Date(t.due_on || t.due_date);
                    return dueDate.toLocaleDateString('en-US', { timeZone: 'America/New_York' }) === todayEST;
                });
            } else if (currentView === 'tasks-overdue') {
                // Show overdue tasks
                filteredTasks = filteredTasks.filter(t => {
                    if (!t.due_on && !t.due_date) return false;
                    const dueDate = new Date(t.due_on || t.due_date);
                    return dueDate < now;
                });
            }

            if (filteredTasks.length === 0) {
                container.innerHTML = '<div class="no-selection"><p>No tasks found</p></div>';
                return;
            }

            container.innerHTML = filteredTasks.slice(0, 20).map(task => {
                const id = task.gid || task.id;
                const name = task.name || 'Untitled';
                const project = task.projects && task.projects[0] ? task.projects[0].name : 'No project';
                const dueDate = task.due_on || task.due_date || 'No due date';
                const priority = task.priority || 'medium';
                const link = `https://app.asana.com/0/${id}`;

                const isExpanded = expandedEmailId === id;

                let html = '<div class="email-item ' + (isExpanded ? 'expanded' : '') + '" onclick="toggleEmail(\'' + id + '\')">' +
                    '<div class="email-header">' +
                        '<div class="email-priority ' + priority + '"></div>' +
                        '<div class="email-content">' +
                            '<div class="email-from">' + escapeHtml(project) + '</div>' +
                            '<div class="email-subject">' + escapeHtml(name) + '</div>' +
                            '<div class="email-preview">Due: ' + escapeHtml(dueDate) + '</div>' +
                        '</div>' +
                        '<div class="email-meta">' +
                            '<span class="email-expand-icon">‚ñ∫</span>' +
                        '</div>' +
                    '</div>';

                if (isExpanded) {
                    html += '<div class="email-details">' +
                        '<div class="email-full-preview">Task: ' + escapeHtml(name) + '<br>Project: ' + escapeHtml(project) + '<br>Due: ' + escapeHtml(dueDate) + '</div>' +
                        '<div class="email-actions">' +
                            '<a href="' + link + '" target="_blank" class="email-action-btn primary" onclick="event.stopPropagation()">Open in Asana</a>' +
                        '</div>' +
                    '</div>';
                }

                html += '</div>';
                return html;
            }).join('');
        }


        // Format email time
        function formatEmailTime(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            const hours = Math.floor(diff / 3600000);

            if (hours < 1) return 'Just now';
            if (hours < 24) return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            if (hours < 48) return 'Yesterday';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        // Force refresh daily briefing (bypass cache)
        async function refreshDailyBriefing() {
            console.log(`üîÑ Force refreshing daily briefing...`);

            const container = document.getElementById('contentList');
            container.innerHTML = '<div class="no-selection"><p style="font-size:1.2rem">Refreshing briefing<span id="loading-dots" style="display:inline-block;width:1.5em;text-align:left">.</span></p><p style="font-size:.8rem;color:var(--text2);margin-top:8px">Processing all folders from M365</p></div>';

            // Animate dots
            const msgDotCount = { count: 1 };
            const msgInterval = setInterval(() => {
                const dotsEl = document.getElementById('loading-dots');
                if (dotsEl) {
                    dotsEl.textContent = '.'.repeat(msgDotCount.count);
                    msgDotCount.count = (msgDotCount.count % 3) + 1;
                }
            }, 500);

            try {
                currentView = 'daily-briefing';
                document.getElementById('view-title').textContent = 'Daily Briefing';

                // Add 30s timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const res = await fetch(`/api/email/triaged-emails`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                clearInterval(msgInterval);

                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }

                const data = await res.json();

                // Reload the briefing display with fresh data
                await generateDailyBriefing();

            } catch (error) {
                clearInterval(msgInterval);
                console.error('‚ùå Refresh failed:', error);
                container.innerHTML = '<div class="no-selection"><p>‚ö†Ô∏è Refresh failed</p><p style="font-size:.8rem;color:var(--text2);margin-top:8px">' + error.message + '</p></div>';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // v8.44: ABBI Chat Functions
        let abbiChatHistory = [];

        // Auto-suggest actions when email loads
        async function autoSuggestActions(email, analysis) {
            const messagesContainer = document.getElementById('abbiChatMessages');
            if (!messagesContainer) return;

            // Clear previous chat history for new email
            abbiChatHistory = [];
            messagesContainer.innerHTML = '';

            // Add system message
            addAbbiChatMessage('assistant', 'üí° Analyzing email and generating action suggestions...');

            try {
                // Build proper email context with all required fields
                const emailContext = {
                    message_id: email.id || analysis.id,
                    email_id: email.id || analysis.id,
                    from: email.from || analysis.from || 'Unknown',
                    to: email.to || 'jstewart@middleground.com',
                    subject: email.subject || analysis.subject || 'No subject',
                    body: analysis.full_body || analysis.body || email.preview || analysis.preview || '',
                    preview: email.preview || analysis.preview || '',
                    received: email.received || analysis.received || email.date || new Date().toISOString(),
                    category: email.category || analysis.category,
                    priority: email.priority || analysis.priority
                };

                const response = await fetch('/api/email/chat-qa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: 'Based on this email, what actions should John take? Provide: 1) Recommended response (if needed), 2) Key action items, 3) Any deadlines or time-sensitive matters. Be specific and actionable.',
                        conversation_history: [],
                        email_context: emailContext
                    })
                });

                const data = await response.json();

                // Remove thinking message
                const lastMessage = messagesContainer.lastElementChild;
                if (lastMessage && lastMessage.textContent.includes('Analyzing')) {
                    messagesContainer.removeChild(lastMessage);
                    abbiChatHistory = []; // Clear the thinking message from history
                }

                if (data.success && data.answer) {
                    addAbbiChatMessage('assistant', data.answer);
                } else {
                    const errorMsg = data.error || 'Could not generate suggestions';
                    console.error('Chat API error:', errorMsg);
                    addAbbiChatMessage('assistant', '‚ùå Could not generate suggestions. Try asking me a question!');
                }
            } catch (error) {
                console.error('Auto-suggest error:', error);
                // Remove thinking message
                const lastMessage = messagesContainer.lastElementChild;
                if (lastMessage && lastMessage.textContent.includes('Analyzing')) {
                    messagesContainer.removeChild(lastMessage);
                }
                // Show more user-friendly error message
                addAbbiChatMessage('assistant', 'üí¨ Ready to help! Ask me anything about this email.');
            }
        }

        async function sendAbbiMessage() {
            const input = document.getElementById('abbiChatInput');
            const messagesContainer = document.getElementById('abbiChatMessages');
            const message = input.value.trim();

            if (!message) return;

            // Clear input and reset height
            input.value = '';
            input.style.height = '44px';

            // Add user message to chat
            addAbbiChatMessage('user', message);

            // Get context from current view
            const context = getCurrentViewContext();

            // Add thinking indicator
            const thinkingDiv = document.createElement('div');
            thinkingDiv.style.cssText = 'padding:12px 16px;background:var(--bg2);border-radius:8px;color:var(--text3);font-size:.85rem;font-style:italic';
            thinkingDiv.textContent = 'üí≠ Thinking...';
            messagesContainer.appendChild(thinkingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                // Call ABBI's chat API with context
                const response = await fetch('/api/email/chat-qa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: message,
                        conversation_history: abbiChatHistory.slice(-6), // Last 6 messages for context
                        email_context: context.emailContext, // Full email analysis with comprehensive summary
                        context: {
                            view: context.currentView,
                            emails: context.emails,
                            calendar: context.calendar
                        }
                    })
                });

                // Remove thinking indicator
                messagesContainer.removeChild(thinkingDiv);

                if (!response.ok) {
                    const error = await response.text();
                    addAbbiChatMessage('assistant', `‚ùå Error: ${error}`);
                    return;
                }

                const data = await response.json();
                if (data.success && data.answer) {
                    addAbbiChatMessage('assistant', data.answer);
                } else {
                    addAbbiChatMessage('assistant', `‚ùå ${data.error || 'No response from ABBI'}`);
                }
            } catch (error) {
                // Remove thinking indicator if still present
                if (thinkingDiv.parentNode) {
                    messagesContainer.removeChild(thinkingDiv);
                }
                addAbbiChatMessage('assistant', `‚ùå Error: ${error.message}`);
            }
        }

        function addAbbiChatMessage(role, message) {
            const messagesContainer = document.getElementById('abbiChatMessages');

            // Remove welcome message if present
            if (messagesContainer.children.length === 1 && messagesContainer.children[0].textContent.includes('Ask me anything')) {
                messagesContainer.innerHTML = '';
            }

            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `padding:12px 16px;border-radius:8px;line-height:1.6;font-size:.95rem;${
                role === 'user'
                    ? 'background:var(--purple);color:#fff;align-self:flex-end;max-width:80%'
                    : 'background:var(--bg2);border:1px solid var(--border);align-self:flex-start;max-width:90%;color:var(--text)'
            }`;

            // Convert text to HTML with line breaks and basic formatting
            let formattedMessage = message
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                .replace(/\*(.*?)\*/g, '<em>$1</em>'); // Italic

            // Convert numbered lists and bullet points to HTML
            if (formattedMessage.includes('<br>-') || formattedMessage.includes('<br>‚Ä¢') || formattedMessage.includes('<br>1.')) {
                formattedMessage = formattedMessage.replace(/(<br>)([‚Ä¢\-]|\d+\.)\s/g, '$1<span style="color:var(--purple);font-weight:600">$2</span> ');
            }

            messageDiv.innerHTML = formattedMessage;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Add to history with 'content' field (required by API)
            abbiChatHistory.push({ role, content: message });
        }

        function getCurrentViewContext() {
            const currentView = document.getElementById('view-title')?.textContent || 'Unknown';
            const emailList = liveData.emails || [];
            const calendar = liveData.calendar || [];

            // Get currently displayed email if any
            const currentEmail = emailList.find(e =>
                document.getElementById(`email-detail-${e.id}`)?.style.display !== 'none'
            );

            // If we're viewing an email detail with full analysis, include that context
            const emailContext = window.currentEmailContext || null;

            return {
                currentView,
                currentEmail,
                emailContext: emailContext, // Full email analysis with comprehensive summary
                emails: emailList.slice(0, 20), // First 20 emails as context
                calendar: calendar.slice(0, 10) // First 10 calendar items
            };
        }

        function toggleAbbiChat() {
            const panel = document.getElementById('abbiChatPanel');
            const btn = event?.target;

            if (panel.style.height === '0px' || panel.style.display === 'none') {
                panel.style.height = '300px';
                panel.style.display = 'flex';
                if (btn) btn.textContent = '‚ñº Hide';
            } else {
                panel.style.height = '0px';
                panel.style.display = 'none';
                if (btn) btn.textContent = '‚ñ≤ Show';
            }
        }

        // Resizable divider for split pane
        (function initSplitPane() {
            const divider = document.getElementById('splitDivider');
            const chatPanel = document.getElementById('abbiChatPanel');
            const contentList = document.getElementById('contentList');

            if (!divider || !chatPanel) return;

            let isDragging = false;
            let startY = 0;
            let startHeight = 0;

            divider.addEventListener('mousedown', (e) => {
                isDragging = true;
                startY = e.clientY;
                startHeight = chatPanel.offsetHeight;
                document.body.style.cursor = 'ns-resize';
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const delta = startY - e.clientY;
                const newHeight = Math.max(150, Math.min(600, startHeight + delta));
                chatPanel.style.height = `${newHeight}px`;
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    document.body.style.cursor = '';
                    document.body.style.userSelect = '';
                }
            });
        })();

        // Load and display last contact sync time
        async function loadContactSyncTime() {
            try {
                const response = await fetch('/api/contacts/last-sync-time');
                const data = await response.json();

                if (data.success && data.last_sync) {
                    const syncDate = new Date(data.last_sync);
                    const now = new Date();
                    const diffMinutes = Math.floor((now - syncDate) / 60000);

                    let timeAgo;
                    if (diffMinutes < 60) {
                        timeAgo = `${diffMinutes}m ago`;
                    } else if (diffMinutes < 1440) {
                        timeAgo = `${Math.floor(diffMinutes / 60)}h ago`;
                    } else {
                        timeAgo = `${Math.floor(diffMinutes / 1440)}d ago`;
                    }

                    document.getElementById('contact-sync-timestamp').textContent = timeAgo;
                    document.getElementById('contact-sync-time').style.display = 'inline';
                    document.getElementById('contact-sync-time').title = `Last synced: ${syncDate.toLocaleString()}\nTotal contacts: ${data.total_contacts || '?'}`;
                }
            } catch (error) {
                console.log('Could not load contact sync time:', error);
            }
        }

        checkAuth();
        restoreCollapseStates();
        loadContactSyncTime(); // Load contact sync timestamp

        // Auto-grow textarea as user types
        const chatInput = document.getElementById('abbiChatInput');
        if (chatInput) {
            chatInput.addEventListener('input', function() {
                this.style.height = '44px'; // Reset to min height
                const newHeight = Math.min(this.scrollHeight, 200); // Max 200px
                this.style.height = newHeight + 'px';
            });
        }
    </script>
</body>
</html>